<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="../../css/comon.css" />
		<link rel="stylesheet" type="text/css" href="../../css/xmgl_detail.css" />
				<link rel="stylesheet" type="text/css" href="../../css/genzongjilu.css" />
		<link rel="stylesheet" type="text/css" href="../../css/mui.picker.min.css"/>
		<script src="../../js/polyfill.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/mui.js"></script>
		<style type="text/css">
			#pullrefresh {
				top: 44px;
				padding: 0;
			}
			#slider {
				margin-top: 60px;
			}
		</style>
		<script type="text/javascript" src="../../js/jquery.min.js">

		</script>
		<script type="text/javascript">
			mui.init({
				gestureConfig: {
					tap: true, //默认为true
					doubletap: true, //默认为false
					longtap: true, //默认为false
					swipe: true, //默认为true
					drag: true, //默认为true
					hold: true, //默认为false，不监听
					release: false //默认为false，不监听
				},
			})
		</script>
	</head>

	<body>
	<header class="mui-bar mui-bar-nav header_box">
		<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
		<h1 class="mui-title">经营管理</h1>
	</header>
	<p class="up_fress data-loading-icon">
		<button type="button" data-loading-icon="mui-spinner mui-spinner-custom" data-loading-text="刷新中" class="loading_btn"></button>
	</p>
		
		<div id="pullrefresh" class="mui-content mui-scroll-wrapper">
			<div class="mui-scroll">
				<div class="project_title_box">
					<h4 class="project_name">海淀区亮甲店保障房智慧工地项目</h4>
					<p>项目编号：<span class="project_number">1234</span></p>
					<div class="receivable">
						<p>已收款</p>
						<p><span class="project_price">12.34</span></p>
					</div>
					<div class="receivable_result">
						<p>是否收款完成</p>
						<p><span class="get_result">否</span></p>
					</div>
				</div>
				<div id="slider" class="mui-slider ">
					<div class="mui-slider detail_title_list">
						<div id="slider_title" class="mui-slider-indicator mui-segmented-control mui-segmented-control-inverted detail_title_list_title">
							<a class="mui-control-item" href="#item1">立项报备<span></span></a>
							<a class="mui-control-item" href="#item2">跟踪记录<span></span></a>
							<a class="mui-control-item" href="#item3">项目投标<span></span></a>
							<a class="mui-control-item is_show" href="#item4">合同审批<span></span></a>
							<a class="mui-control-item is_show" href="#item5">任务分配<span></span></a>
						</div>
						<hr>
						<!-- <div id="sliderProgressBar" class="mui-slider-progress-bar mui-col-xs-2"></div> -->
					</div>
					<div class="mui-slider-group">	
						<div id="scroll1" >
							<div class="mui-slider-group detail_list_tab" id="detail_list">
								<div id="item1" class="mui-slider-item mui-control-content project_detail">
									<div class="mui-table-view project_detail_list">
										<p>
											<img src="../../img/baobei.png">
											立项报备
										</p>
										<div class="detail_info">
											<p>项目名称：<span class="project_name">项目管理</span></p>
											<p>项目编号：<span class="project_num">123456</span></p>
											<p>客户需求：<span class="project_require">管理</span></p>
											<p>客户名称：<span class="contacts_name">北控建设集团</span></p>
											<p>联系人：<span class="contacts_peo">北控建设集团</span></p>
											<p>联系电话：<span class="contacts_phone">123456</span></p>
											<p class="span_btn"><span class="update_projefct">修改项目信息</span><span class="check_update">查看修改记录</span></p>
										</div>
									</div>
								</div>
								<div id="item2" class="mui-slider-item mui-control-content project_detail">
									<div class="mui-table-view project_detail_list project_task_point">
										<p>
											<img src="../../img/jilu.png">
											跟踪记录
											<span class="add_point add_record">添加</span>
										</p>
										<div class="detail_info detail_info_no_data bid_no_data">
											<img src="../../img/no_data.png">
											<p>没有记录</p>
										</div>
										<div class="record_list" style="display: none;">
											<ul>
												<li>
													<div class="record_list_left">
														<span class="time_year">2016</span>
														<p>10-30 <span></span></p>
													</div>
													<div class="record_list_right">
														<span></span>
														<div class="record_list_right_box">
														</div>
													</div>
												</li>
												<li class="end_save">
													<div class="record_list_left">
														<span class="time_year" style="display: none;">2016</span>
														<p>10-30 <span></span></p>
													</div>
													<div class="record_list_right">
														<span style="display: none;"></span>
														<div class="record_list_right_box">
															<div class="detail_info">
																<p>拜访人员：<span>项目管理</span></p>
																<p>联系电话：<span>123123123</span></p>
																<p>拜访目的：<span>系统开发</span></p>
																<p>拜访结果：<span>按时完成开发</span></p>
																<p>记录状态：<span>技术开发合同</span></p>
															</div>
														</div>
													</div>
												</li>
											</ul>
										</div>
									</div>
													
								</div>
								<div id="item3" class="mui-slider-item mui-control-content project_detail">
									<div class="mui-table-view project_detail_list project_task_point">
										<p>
											<img src="../../img/toubiao.png">
											项目投标
											<span class="add_point add_bid">添加</span>
										</p>
										<div class="detail_info detail_info_no_data bid_no_data">
											<img src="../../img/no_data.png">
											<p>未申请</p>
										</div>
										<div class="detail_info bid_data" style="display: none;">
											<p>申请人员：<span>系统开发</span></p>
											<p>申请状态：<span>系统开发</span></p>
											<p>编制人员：<span>10工时</span></p>
											<p>盖章申请：<span>10工时</span></p>
											<p>原件申请：<span>营业执照</span></p>
											<p>原件借用时间：<span>2019-09-05 至 2019-09-06</span></p>
											<p>保证金要求：<span>否</span></p>
										</div>
									</div>
													
									<hr>
													
									<div class="mui-table-view project_detail_list project_task_point">
										<p>
											<img src="../../img/toubiao.png">
											投标结果备案
											<span class="add_point keep_on_record">添加</span>
										</p>
										<div class="detail_info detail_info_no_data result_bid">
											<img src="../../img/no_data.png">
											<p>未申请</p>
										</div>
										<div class="detail_info update_bid_result" style="display: none;">
											<p>是否中标：<span>中标</span></p>
											<p>中标价格（万元）：<span>12</span></p>
											<p>备注：<span>123123</span></p>
										</div>
									</div>
								</div>
								<div id="item4" class="mui-slider-item mui-control-content project_detail">
													
									<div class="mui-table-view project_detail_list project_task_point">
										<p>
											<img src="../../img/hetong.png">
											合同信息
											<span class="add_point add_contract">添加</span>
										</p>
										<div class="contract_list">
													
										</div>
									</div>
								</div>
								<div id="item5" class="mui-slider-item mui-control-content project_detail">
													
									<div class="mui-table-view project_detail_list project_task_point">
										<p>
											<img src="../../img/task.png">
											任务单
											<span class="add_point add_task_btn">添加</span>
										</p>
										<div class="detail_info detail_info_no_data">
											<img src="../../img/no_data.png">
											<p>未发起</p>
										</div>
										<div class="detail_info task_detail" style="display: none;">
											<p>任务接收人：<span>特斯</span></p>
											<p>执行时间：<span>2019-09-06</span></p>
											<p>工作内容：<span>某某系统</span></p>
											<p>工作要求：<span>按时完成</span></p>
											<p>项目合同：<span class="file_name">技术资料.doc</span></p>
											<p>委托资料：<span class="file_name">技术资料.doc</span></p>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			
		</div>
		<p class="down_fress data-loading-icon">
			<button type="button" data-loading-icon="mui-spinner mui-spinner-custom" data-loading-text="加载中" class="loading_btn"></button>
		</p>
	</body>
	<script src="../../js/mui.pullToRefresh.js"></script>
	<script src="../../js/mui.pullToRefresh.material.js"></script>
	<script type="text/javascript" src="../../js/jquery.min.js"></script>
	<script src="../../js/mui.picker.min.js" type="text/javascript" charset="utf-8"></script>
	<script type="text/javascript" src="../../js/request.js"></script>
	<script src="../../js/common.js" type="text/javascript" charset="utf-8"></script>
	<script src="../../js/loading.js" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript">
	// $('#slider').slider().gotoItem(index)

	mui.showLoading("正在加载..", "div");
	var getId = common.getQueryUrl('id');
	var refushNum = localStorage.getItem('detail_num') || 1; //刷新当前页码
	localStorage.setItem('detail_num',refushNum);
	$('#slider_title').find('a').eq(refushNum - 1).addClass('mui-active');
	$('#item'+refushNum).addClass('mui-active')

	var recordIndex = 1; //record当前页
	var contractIndex = 1; //合同当前页
	var contractData = [];
	
	
	show()
	function show() {

		var leng = $('#slider_title a');
		for(var i=0;i<leng.length;i++) {
			if($(leng[i]).html().indexOf('立项报备') != -1) {
				if(!getModuleName('ManagementLXBB')) {
					$(leng[i]).attr('href','').removeClass('mui-control-item')
					$('#item1').hide();
				}
			}
			if($(leng[i]).html().indexOf('跟踪记录') != -1) {
				if(!getModuleName('ManagementGZJL')) {
					$(leng[i]).attr('href','').removeClass('mui-control-item')
					$('#item2').hide();
				}
			}
			if($(leng[i]).html().indexOf('项目投标') != -1) {
				if(!getModuleName('ManagementXMTB')) {
					$(leng[i]).attr('href','').removeClass('mui-control-item')
					$('#item3').hide();
				}
			}
			if($(leng[i]).html().indexOf('合同审批') != -1) {
				if(!getModuleName('ManagementHTSP')) {
					$(leng[i]).attr('href','').removeClass('mui-control-item')
					$('#item4').hide();
				}
			}
			if($(leng[i]).html().indexOf('任务分配') != -1) {
				if(!getModuleName('ManagementRWD_ZBDL')) {
					$(leng[i]).attr('href','').removeClass('mui-control-item')
					$('#item5').hide();
				}
			}
		}
		for(var i=0;i<leng.length;i++) {
			if(!$(leng[i]).hasClass('mui-control-item')) {
				$(leng[i]).remove();
			}
		}
	}

	//定义的全局变量
	
	//silder切换
	mui('.mui-slider').slider().stopped = true;
	mui('#slider_title').on('tap', 'a', function() {
		var num = $(this).attr('href').substr(5);
		var width = $(window).width();
		refushNum = num;
		localStorage.setItem('detail_num',refushNum);
		action(width,num);
	})
	function action(width,num) {
		if (width < 410) {
			if (num >= 3) {
				$("#slider_title").scrollLeft(90 * (num - 3 + 1));
			} else {
				$("#slider_title").scrollLeft(0);
			}
		} else {
			if (num >= 5) {
				$("#slider_title").scrollLeft(90);
			} else {
				$("#slider_title").scrollLeft(0);
			}
		}
	}
	

	var scroll = mui('.mui-scroll-wrapper').scroll();
	var isFresh = false;
	document.querySelector('.mui-scroll-wrapper').addEventListener('scroll', function(e) {
		if (refushNum == 1 || refushNum == 3 || isFresh) {
			return;
		}
		if (scroll.y > 0) {
			if (scroll.y > 50) {
				isFresh = true;
				$('#pullrefresh').css('paddingTop', '40px');
				mui('.loading_btn').button('loading');
				$('.up_fress').css('zIndex', '3');
				pulldownRefresh().then(function() {
					setTimeout(function() {
						$('.up_fress').css('zIndex', '2');
						$('#pullrefresh').css('paddingTop', '0px');
						mui('.loading_btn').button('reset');
						isFresh = false;
					}, 1000)
				})
			}
		}

		if (scroll.y != 0 && scroll.y < scroll.maxScrollY) {
			if (refushNum == 2) {
				var length = $('.record_list ul').find('li').length;
				return common.promise();
			}
			//上拉加载逻辑代码
			isFresh = true;
			$('#pullrefresh').css('bottom', '40px');
			$('.down_fress').css('zIndex', '2');
			mui('.loading_btn').button('loading');
			pullupRefresh().then(function() {
				setTimeout(function() {
					$('#pullrefresh').css('bottom', '0px');
					$('.down_fress').css('zIndex', '0');
					mui('.loading_btn').button('reset');
					isFresh = false;
				}, 1000)
			})
		}
	})

	function pulldownRefresh() {
		if (refushNum == 2) {
			return getRecord(1);
		} else if (refushNum == 4) {
			return getContractInfo(1);
		}
		return common.promise();
	}

	function pullupRefresh() {
		if (refushNum == 2) {
			var length = $('.record_list ul').find('li').length;
			if (length % 10 == 0) {
				recordIndex++;
				return getRecord(recordIndex, true);
			} else {
				return common.promise();
			}
		} else if (refushNum == 2) {
			var length = $('.contract_list').find('.detail_info').length;
			if (length % 10 == 0) {
				contractIndex++;
				return getRecord(contractIndex, true);
			} else {
				return common.promise();
			}
		}
		return common.promise();
	}


	common.promise()
		.then(getProjectDetail)
		.then(function(res) {
			console.log('详情：',res);
			if (res.code == 200) {
				$('.project_name').html(res.data.Name);
				$('.project_num').html(res.data.Number);
				$('.project_require').html(res.data.CustomerRequirement);
				$('.contacts_name').html(res.data.ConstructionUnit);
				$('.contacts_peo').html(res.data.ConstructionUnitLinkMan);
				$('.contacts_phone').html(res.data.ConstructionUnitTel);
				$('.project_price').html(res.data.ReceivePrice);
				$('.get_result').html(res.data.IsReceiveCompleted ? '是' : '否');
				$('.project_number').html(res.data.Number)
				mui('.mui-scroll-wrapper').scroll().scrollTo(0, 0);
			}
			return getRecord(1);
		})
		.then(function(res) {
			console.log('记录：',res);
			recordData(res);
			return getProjectBidDetail();
		})
		.then(function(res) {
			console.log('投标：',res)
			if (res.code == 200) {
				var bid = res.data.Bid;
				var bidResult = res.data.BidResult;
				if (bid) {
					$('.bid_no_data').css('display', 'none');
					var html = '<p>申请人员：<span>' + common.getNotNullData(bid.SQRY) + '</span></p>' +
						'<p>申请状态：<span>' + bid.Status + '</span></p>' +
						'<p>编制人员：<span>' + common.getNotNullData(bid.FZR) + '</span></p>' +
						'<p>盖章申请：<span>' + common.getNotNullData(bid.Stamp) + '</span></p>' +
						'<p>原件申请：<span>' + bid.YJSQ + '</span></p>' +
						'<p>原件借用时间：<span>' + bid.OriginalBegin.split(' ')[0] + ' 至 ' + bid.OriginalEnd.split(' ')[0] + '</span></p>' +
						'<p>保证金要求：<span>' + bid.requirementStr + '</span></p>'
					$('.bid_data').html(html);
					$('.bid_data').css('display', 'block');
					$('.add_bid').hide();
				}
				if (bidResult) {
					$('.result_bid').css('display', 'none');
					var reHtml = '<p>是否中标：<span>' + bidResult.IsWinStr + '</span></p>' +
						'<p>中标价格（万元）：<span>' + (bidResult.WinPrice || 0) + '</span></p>' +
						'<p>备注：<span>' + common.getNotNullData(bidResult.Remark) + '</span></p>';
					$('.update_bid_result').html(reHtml);
					$('.update_bid_result').css('display', 'block');
					$('.keep_on_record').hide();
					if(bidResult.IsWinStr == '未中标') {
						$('.is_show').hide();
					}
				}
			}else {
				mui.toast('获取项目投标信息失败！')
				$('#item3 .bid_no_data').css('display', 'block');
				$('#item3 .result_bid').css('display', 'block');
			}
			return getContractInfo(1);
		})
		.then(function(res) {
			console.log('合同：',res);
			contractDataFn(res);
			return getTask();
		})
		.then(function(res) {
			console.log('任务单：',res);
			if (res.code == 200) {
				if(res.data.Id) {
					$('.add_task_btn').html('查看')
				}
				var name = '';
				if(Object.keys(res.data.Contract).length > 0) {
					for (var i = 0; i < res.data.Contract.lstFile.length; i++) {
						var list = res.data.Contract.lstFile[i];
						if (name == '') {
							name = '<span class="file_name" path='+ list.FilePath +'>' + list.FileName + '</span>';
						}else {
							name += '、'+'<span class="file_name" path='+ list.FilePath +'>' + list.FileName + '</span>';
						}
					}
				}
				var str = '';
				var fileList = res.data.lstFile
				for (var i = 0; i < fileList.length; i++) {
					if (str == '') {
						str += '<span class="file_name" path='+ fileList[i].FilePath +'>'+fileList[i].FileName + fileList[i].Extension+'</span>';
					} else {
						str += ',' + '<span class="file_name" path='+ fileList[i].FilePath +'>'+fileList[i].FileName + fileList[i].Extension+'</span>';
					}
				}
				$('#item5 .detail_info_no_data').css('display', 'none');
				var html = '<p>任务接收人：<span></span></p>' +
					'<p>执行时间：<span>' + common.getNotNullData(res.data.BeginTime) + '</span></p>' +
					'<p>工作内容：<span>' + common.getNotNullData(res.data.WorkContents) + '</span></p>' +
					'<p>工作要求：<span>' + common.getNotNullData(res.data.WorkRequire) + '</span></p>' +
					'<p>项目合同：' + name + '</p>' +
					'<p>委托资料：' + str + '</p>';
				$('.task_detail').html(html);
				$('.task_detail').css('display', 'block');
			}
			mui.hideLoading(function() {});
		})
		

	


	function recordData(res) {
		var flag = res.flag;
		if (res.code == 200) {
			if (res.data.length > 0) {
				$('.record_list').css('display', 'block');
				$('#item2 .bid_no_data').css('display', 'none');
			}
			var year = 0;
			var innerHtml = '';
			for (var i = 0; i < res.data.length; i++) {
				var item = res.data[i];
				var visitTime = item.VisitTime;
				if (year != visitTime.split('-')[0]) {
					year = visitTime.split('-')[0];
					console.log('year:', year);
					if (item.State == 0) {
						innerHtml += '<li class="end_save" listId="' + item.Id +
							'"><div class="record_list_left"><span class="time_year">' +
							visitTime.split('-')[0] + '</span>' +
							'<p>' + visitTime.split('-')[1] + '-' + visitTime.split('-')[2] +
							'<span></span></p></div><div class="record_list_right"><span></span>' +
							'<div class="record_list_right_box"><div class="detail_info">' +
							'<p>拜访人员：<span>' + common.getNotNullData(item.LinkMan)  + 
							'</span></p><p>联系电话：<span>' + common.getNotNullData(item.Tel) + '</span></p>' +
							'<p>拜访目的：<span>' + common.getNotNullData(item.PlanPurpose) + 
							'</span></p><p>拜访结果：<span>' + common.getNotNullData(item.PlanResult) + '</span></p>' +
							'<p>记录状态：<span>' + (item.State == 0 ? "已保存" : "已提交") + '</span></p></div></div></div></li>';
					} else {
						innerHtml += '<li listId="' + item.Id + '"><div class="record_list_left"><span class="time_year">' +
							visitTime.split('-')[0] + '</span>' +
							'<p>' + visitTime.split('-')[1] + '-' + visitTime.split('-')[2] +
							'<span></span></p></div><div class="record_list_right"><span></span>' +
							'<div class="record_list_right_box"><div class="detail_info">' +
							'<p>拜访人员：<span>' + common.getNotNullData(item.LinkMan)  +
							'</span></p><p>联系电话：<span>' + common.getNotNullData(item.Tel) + '</span></p>' +
							'<p>拜访目的：<span>' + common.getNotNullData(item.PlanPurpose) + 
							'</span></p><p>拜访结果：<span>' + common.getNotNullData(item.PlanResult) + '</span></p>' +
							'<p>记录状态：<span>' + (item.State == 0 ? "已保存" : "已提交") + '</span></p></div></div></div></li>';
					}
				} else {
					if (item.State == 0) {
						innerHtml += '<li class="end_save" listId="' + item.Id +
							'"><div class="record_list_left"><span class="time_year" style="display: none;">' +
							visitTime.split('-')[0] + '</span>' +
							'<p>' + visitTime.split('-')[1] + '-' + visitTime.split('-')[2] +
							'<span></span></p></div><div class="record_list_right"><span style="display: none;"></span>' +
							'<div class="record_list_right_box"><div class="detail_info">' +
							'<p>拜访人员：<span>' + common.getNotNullData(item.LinkMan)  +
							'</span></p><p>联系电话：<span>' + common.getNotNullData(item.Tel) + '</span></p>' +
							'<p>拜访目的：<span>' + common.getNotNullData(item.PlanPurpose) + 
							'</span></p><p>拜访结果：<span>' + common.getNotNullData(item.PlanResult) + '</span></p>' +
							'<p>记录状态：<span>' + (item.State == 0 ? "已保存" : "已提交") + '</span></p></div></div></div></li>';
					} else {
						innerHtml += '<li listId="' + item.Id +
							'"><div class="record_list_left"><span class="time_year" style="display: none;">' +
							visitTime.split('-')[0] + '</span>' +
							'<p>' + visitTime.split('-')[1] + '-' + visitTime.split('-')[2] +
							'<span></span></p></div><div class="record_list_right"><span style="display: none;"></span>' +
							'<div class="record_list_right_box"><div class="detail_info">' +
							'<p>拜访人员：<span>' + common.getNotNullData(item.LinkMan)  +
							'</span></p><p>联系电话：<span>' + common.getNotNullData(item.Tel) + '</span></p>' +
							'<p>拜访目的：<span>' + common.getNotNullData(item.PlanPurpose) + 
							'</span></p><p>拜访结果：<span>' + common.getNotNullData(item.PlanResult) + '</span></p>' +
							'<p>记录状态：<span>' + (item.State == 0 ? "已保存" : "已提交") + '</span></p></div></div></div></li>';
					}
				}
			}
		
			if (flag) {
				$('#item2 .record_list ul').append(innerHtml);
			} else {
				$('#item2 .record_list ul').html(innerHtml);
			}
		}
	}

	function contractDataFn(res) {
		var flag = res.flag;
		if (res.code == 200) {
			var data = res.data;
			contractData = res.data;
			var html = ''
			for (var i = 0; i < data.length; i++) {
				var classStatus = '';
				if (data[i].State == 1) {
					classStatus = 'audit_status_ing';
				} else if (data[i].State == 2) {
					classStatus = 'audit_status_success';
				} else if (data[i].State == -1) {
					classStatus = 'audit_status_refuse';
				} else {
					classStatus = ''
				}
				console.log(data[i].SignTime == '')
				var btnhtml ='';
				if(data[i].State == 2) {
					btnhtml = data[i].SignTime != '' ? '':'<div class="signing_date"><span class="btn_time">录入签订日期</span></div>';
				}
				html += '<div class="detail_info contract_detail" Id=' + data[i].Id + '>' +
					// '<h3>' + data[i].Name + '</h3>' +
					'<p>合同编号：<span>' + (data[i].FullNumber || '') + '</span></p>' +
					'<p>合同金额（元）：<span>' + (data[i].Price || 0) + '</span></p>' +
					'<p>录入时间：<span>' + data[i].CreateTime + '</span></p>' +
					'<p>审批状态：<span class=' + classStatus + '>' + data[i].Status + '</span></p>' +
					'<p>签订日期：<span class="sign_time">'+ (data[i].SignTime ?  data[i].SignTime : '未录入') +'</span></p>' +btnhtml
					+
					'</div>';
			}
			if(res.data.length == 0) {
				html = '<div class="detail_info detail_info_no_data bid_no_data">'+
				'<img src="../../img/no_data.png"><p>没有记录</p></div>';
			}
			if (flag) {
				$('.contract_list').append(html);
			} else {
				$('.contract_list').html(html);
			}
		}
	}
	

	//长按删除
	mui('#item2').on('longtap', 'li', function(e) {
		console.log(123123)
		$('#item2').find('#middlePopover').remove();
		$(this).append(
			'<div id="middlePopover" class="mui-popover"><button type="button" class="mui-btn mui-btn-blue mui-btn-outlined delete_record">删除</button><span></span></div>'
		);
		$('#middlePopover').show()
	})

	mui('html').on('tap', 'body', function(e) {
		$('#middlePopover').hide();
		if($(e.target).hasClass('file_name')) {
			return;
		}
	})
	//删除跟踪记录
	mui('#item2').on('tap', '.delete_record', function(e) {
		e.stopPropagation();
		var isCreate = true;
		if(getModuleName('ManagementGZJL')) {
			if(operationArr.length > 0) {
				for(var i=0;i<operationArr.length;i++) {
					if(operationArr[i].KeyCode == 'Delete') {
						if(!operationArr[i].IsValid) {
							isCreate = false;
						}
					}
				}
			}
		}
		if(!isCreate) {
			mui.toast('没有权限！');
			$('#middlePopover').hide();
			return;
		}
		var id = $(this).parents('li').attr('listId');
		var _this = this;
		var deleteUrl = '/api/BusinessManage/DeleteTrackRecord';
		var postdta = {
			Ids: [id]
		}
		request.post(deleteUrl, postdta).then(function(res) {
			console.log(res)
			
			if (res.code == 200) {
				mui.toast('删除成功！');
				$(_this).parents('li').remove();
			} else {
				mui.toast('删除失败！')
			}
		})
	})

	//获取项目详情
	function getProjectDetail() {
		var getUrl = '/api/BusinessManage/Detail';
		return request.post(getUrl, {
			ProjectId: getId
		}).then(function(res) {
			return res;
		})
	}

	//修改项目信息
	mui('#item1').on('tap', '.update_projefct', function() {
		var isUpdate = true;
		if(getModuleName('ManagementLXBB')) {
			if(operationArr.length > 0) {
				for(var i=0;i<operationArr.length;i++) {
					if(operationArr[i].KeyCode == 'Update') {
						if(!operationArr[i].IsValid) {
							isUpdate = false;
						}
					}
				}
			}
		}
		if(isUpdate) {
			window.location.href = './new_project.html?id=' + getId;
		}else {
			mui.toast('没有权限！');
		}
		
	})
	
	//查看修改记录 check_update
	mui('#item1').on('tap', '.check_update', function() {
		window.location.href = './update_record.html?id=' + getId + '&name=' + $('.project_name').html();
	})
	

	//获取跟踪记录
	//flag 判断是否是上拉加载
	function getRecord(index, flag) {
		var recordUrl = '/api/BusinessManage/TrackRecordList';
		var postData = {
			ProjectId: getId,
			Page: index,
			Limit: 100
		}
		return request.post(recordUrl, postData).then(function(res) {
			res.flag = flag;
			return res;
		})
	}

	//添加跟踪记录
	mui('#item2').on('tap', '.add_record', function() {
		var isCreate = true;
		if(getModuleName('ManagementGZJL')) {
			if(operationArr.length > 0) {
				for(var i=0;i<operationArr.length;i++) {
					if(operationArr[i].KeyCode == 'Create') {
						if(!operationArr[i].IsValid) {
							isCreate = false;
						}
					}
				}
			}
		}
		if(isCreate) {
			window.location.href = './add_record.html?id=' + getId + '&name=' + $('.project_name').html();
		}else {
			mui.toast('没有权限！');
		}
		
	})

	//点击修改跟踪记录
	mui('#item2').on('tap', 'li', function(e) {
		if($('#middlePopover').css('display') == 'block') {
			$('#middlePopover').hide();
			return;
		}
		var isCreate = true;
		if(getModuleName('ManagementGZJL')) {
			if(operationArr.length > 0) {
				for(var i=0;i<operationArr.length;i++) {
					if(operationArr[i].KeyCode == 'Update') {
						if(!operationArr[i].IsValid) {
							isCreate = false;
						}
					}
				}
			}
		}
		if(isCreate) {
			window.location.href = './add_record.html?update=true&id=' + $(this).attr('listId') + '&name=' + $('.project_name')
				.html();
		}else {
			mui.toast('没有权限');
		}
		
	})


	//获取项目投标详情
	function getProjectBidDetail() {
		var getBidUrl = '/api/BusinessManage/XMTB';
		return request.post(getBidUrl, {
			ProjectId: getId
		}).then(function(res) {
			return res;
		})
	}


	//获取合同信息
	function getContractInfo(index, flag) {
		var url = '/api/BusinessManage/HTSP';
		var postData = {
			ProjectId: getId,
			Page: index,
			Limit: 100
		}
		return request.post(url, postData).then(function(res) {
			res.flag = flag;
			return res;
		})
	}

	//获取任务单信息
	function getTask() {
		var url = '/api/BusinessManage/RWDDetail';
		return request.post(url, {
			ProjectId: getId
		}).then(function(res) {
			return res;
		})
	}

	//点击添加投标
	mui('#item3').on('tap', '.add_bid', function() {
		var isCreate = true;
		if(getModuleName('ManagementTBSQ')) {
			if(operationArr.length > 0) {
				for(var i=0;i<operationArr.length;i++) {
					if(operationArr[i].KeyCode == 'Create') {
						if(!operationArr[i].IsValid) {
							isCreate = false;
						}
					}
				}
			}
		}
		
		if(isCreate) {
			window.location.href = './toubiaoshengqing.html?id=' + getId + '&name=' + $('.project_name').html();
		}else {
			mui.toast('没有权限！');
		}
		
	})
	//点击修改投标
	mui('#item3').on('tap', '.bid_data', function() {
		var isCreate = true;
		if(getModuleName('ManagementTBSQ')) {
			if(operationArr.length > 0) {
				for(var i=0;i<operationArr.length;i++) {
					if(operationArr[i].KeyCode == 'Update') {
						if(!operationArr[i].IsValid) {
							isCreate = false;
						}
					}
				}
			}
		}
		if(isCreate) {
			window.location.href = './toubiaoshengqing.html?id=' + getId + '&name=' + $('.project_name').html() +
				'&detail=true';
		}else {
			mui.toast('没有权限！');
		}
	})

	//投标结果备案
	mui('#item3').on('tap', '.keep_on_record', function() {
		var isCreate = true;
		if(getModuleName('ManagementTBJGBA')) {
			if(operationArr.length > 0) {
				for(var i=0;i<operationArr.length;i++) {
					if(operationArr[i].KeyCode == 'Create') {
						if(!operationArr[i].IsValid) {
							isCreate = false;
						}
					}
				}
			}
		}
		if(isCreate) {
			window.location.href = './toubiaojieguobeian.html?id=' + getId + '&name=' + $('.project_name').html();
		}else {
			mui.toast('没有权限！');
		}
		
	})

	//修改投标结果备案
	mui('#item3').on('tap', '.update_bid_result', function() {
		var isCreate = true;
		if(getModuleName('ManagementTBJGBA')) {
			if(operationArr.length > 0) {
				for(var i=0;i<operationArr.length;i++) {
					if(operationArr[i].KeyCode == 'Update') {
						if(!operationArr[i].IsValid) {
							isCreate = false;
						}
					}
				}
			}
		}
		if(isCreate) {
			window.location.href = './toubiaojieguobeian.html?id=' + getId + '&name=' + $('.project_name').html() +
				'&detail=true';
		}else {
			mui.toast('没有权限！');
		}
		
	})

	//添加合同
	mui('#item4').on('tap', '.add_contract', function() {
		var isCreate = true;
		if(getModuleName('ManagementHTSP')) {
			if(operationArr.length > 0) {
				for(var i=0;i<operationArr.length;i++) {
					if(operationArr[i].KeyCode == 'Create') {
						if(!operationArr[i].IsValid) {
							isCreate = false;
						}
					}
				}
			}
		}
		if(isCreate) {
			window.location.href = './htsp_table.html?id=' + getId + '&name=' + $('.project_name').html();
		}else {
			mui.toast('没有权限！');
		}
		
	})
	//修改合同
	mui('#item4').on('tap', '.contract_detail', function(e) {
		var _id = $(this).attr('Id');
		var isCreate = true;
		if(getModuleName('ManagementHTSP')) {
			if(operationArr.length > 0) {
				for(var i=0;i<operationArr.length;i++) {
					if(operationArr[i].KeyCode == 'Update') {
						if(!operationArr[i].IsValid) {
							isCreate = false;
						}
					}
				}
			}
		}
		if($(e.target).hasClass('btn_time') && isCreate) {
			var _self = this;
			var optionsJson = this.getAttribute('data-options') || '{}';
			var options = JSON.parse(optionsJson);
			options = {
				type: 'date'
			}
			var id = this.getAttribute('id');
			_self.picker = new mui.DtPicker(options);
			_self.picker.show(function(rs) {
				console.log(rs.text)
				// $(_self).find('a').html(rs.text);
				saveTime(_id,rs.text,_self)
				_self.picker.dispose();
				_self.picker = null;
			});
			return;
		}
		
		
		if(isCreate) {
			window.location.href = './htsp_table.html?id=' + getId + '&name=' + $('.project_name').html() + '&detail=true&Id=' +
				_id;
		}else {
			mui.toast('没有权限！');
		}
		
		
	})
	
	function saveTime(id,time,self) {
		var url = '/api/BusinessManage/SaveSignTime';
		request.post(url,{Id: id,SignTime: time}).then(function(res) {
			console.log(res)
			if(res.code == 200) {
				$(self).find('.sign_time').html(time);
				mui.toast('录入成功！');
			}else {
				mui.toast('录入失败！')
			}
		})
	}

	//添加任务单
	mui('#item5').on('tap', '.add_task_btn', function(e) {
		var isCreate = true;
		if($(e.target).hasClass('file_name')) {
			return;
		}
		if(getModuleName('ManagementRWDNew_ZJZX')) {
			if(operationArr.length > 0) {
				for(var i=0;i<operationArr.length;i++) {
					if(operationArr[i].KeyCode == 'Create') {
						if(!operationArr[i].IsValid) {
							isCreate = false;
						}
					}
					if(operationArr[i].KeyCode == 'Update') {
						if(!operationArr[i].IsValid) {
							isCreate = false;
						}
					}
				}
			}
		}
		if(isCreate) {
			window.location.href = './add_task.html?id=' + getId + '&name=' + $('.project_name').html();
		}else {
			mui.toast('没有权限！');
		}
		
	});
	
	mui('#item5').on('tap', '.file_name', function(e) {
		console.log(123)
		var path = $(this).attr('path');
		console.log(path)
		mui.showLoading('加载中...');
		openFile(baseUrl +path)
	});
	
</script>
</html>
