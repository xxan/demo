<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title></title>
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <link href="../../css/mui.css" rel="stylesheet" />
    <link rel="stylesheet" type="text/css" href="../../css/comon.css" />
    <link rel="stylesheet" type="text/css" href="../../css/add_task_point.css" />
    <script src="../../js/mui.js"></script>
    <link rel="stylesheet" type="text/css" href="../../css/mui.picker.min.css" />
		<link rel="stylesheet" type="text/css" href="../../css/list_content_procedure.css"/>
		<link rel="stylesheet" type="text/css" href="../../css/Details.css" />
		<script src="../../js/polyfill.js" type="text/javascript" charset="utf-8"></script>
    <script type="text/javascript" src="../../js/jquery.min.js"></script>
    <script type="text/javascript">
        mui.init()
    </script>
		<style type="text/css">
			
			.message_content {
				margin-bottom: 50px;
				border-top: solid 1px #f2f2f2;
			}
				
			.mui-content {
				padding-bottom: 70px;
			}
			
			.file_name {
				color: #3B9CFF;
			}
			
			.file_title {
				height: 30px;
				line-height: 30px;
				padding-left: 20px;
				font-size: 14px;
			}
			
			pre{
				width: 100%;
				overflow-y: scroll;
			}
			
			.message_title.fjl li p{
				
			}
			.message_title.fjl li div{
				width: 75%;
				vertical-align: top;
			}
		
		</style>
</head>

<body>
    <header class="mui-bar mui-bar-nav header_box">
        <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
        <h1 class="mui-title">合同审批表</h1>
    </header>
    <div class="mui-content">
        <ul class="message_title">
            <!--<li><p>合同名称：</p><div>海淀区亮甲店保障房技术服务合同</div></li>
            <li><p>合同编号：</p><div>2B9943</div></li>
            <li><p>合同向对方：</p><div>北京北排集团</div></li>
            <li><p>收款方式：</p><div>汇款</div></li>
            <li><p>合同类型：</p><div>智慧建造</div></li>
            <li><p>合同金额(万元)：</p><div>58</div></li>
            <li><p>合同工期：</p><div>2019-10-11 至 2019-12-22</div></li>
            <li><p>主要条款：</p><div></div></li>
            <li><p>备注：</p><div></div></li>
            <li><p>合同文件：</p><div><a>智慧建造合同.doc</a></div></li>
            <li><p>附件：</p><div></div></li>
            <li><p>盖章文件：</p><div>6</div></li>
            <li><p>份数：</p><div></div></li>
            <li><p>盖章位置及要求：</p><div></div></li>-->
            <!-- <img class="htsp_zt" src="../../img/htsp_zt_spz.png"/> -->
            <!-- <img class="htsp_zt" src="../../img/htsp_zt_wtg.png"/> -->
            <!-- <img class="htsp_zt" src="../../img/htsp_zt_tg.png"/>-->
        </ul>
        <div class="message_content">
            <ul class="list_content_procedure"></ul>
        </div>
        <div class="footer_submit" style="display: none;">
            <span class="btn_cancell">拒绝</span><span class="btn_submit">同意</span>
        </div>
        <!-- 弹框开始 -->
        <div class="htsp_modal htsp_modal_jj">
            <div class="mui-modal_all">
                <div class="mui-modal_all_title">确认拒绝<span class="mui-icon mui-icon-close"></span></div>
                <div class="htsp_modal_nr"><textarea id="opinioncancel" autofocus></textarea></div>
								<div class="sign_box">
									<p>点击添加手写签名</p>
									<div class="sign_img">
										<img src="../../img/add_sign.png" >
									</div>
								</div>
                <div class="modal_btn"><span class="modal_btn_qr cancel">确认拒绝</span></div>
            </div>
        </div>
        <div class="htsp_modal htsp_modal_ty">
            <div class="mui-modal_all">
                <div class="mui-modal_all_title">确认同意<span class="mui-icon mui-icon-close"></span></div>
                <div class="htsp_modal_nr"><textarea id="opinionok" autofocus></textarea></div>
								<div class="sign_box">
									<p>点击添加手写签名</p>
									<div class="sign_img">
										<img src="../../img/add_sign.png" >
									</div>
								</div>
                <div class="modal_btn"><span class="modal_btn_qr ok">确认同意</span></div>
            </div>
        </div>
				
				<div class="htsp_modal sign_modal">
					<div class="content_box">
						<div class="mui-modal_all_title">添加签名<span class="mui-icon mui-icon-close"></span></div>
						<div class="canvas_box" style="overflow: hidden;">
							<canvas id="canvas"></canvas>
						</div>
						<div class="canvas_btn">
							<span class="canvas_reset">重置</span><span class="canvas_save">保存</span>
						</div>
					</div>
				</div>
        <!-- 弹框结束 -->
    </div>
</body>
</html>
<script src="../../js/mui.picker.min.js" type="text/javascript" charset="utf-8"></script>
<script src="../../js/request.js" type="text/javascript" charset="utf-8"></script>
<script src="../../js/common.js" type="text/javascript" charset="utf-8"></script>
<script src="../../js/loading.js" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript">
    //mui('.footer_submit').on('tap', '.btn_save', function() {
    //    mui.back();
    //});
		var isShowAngree = false;
		var signfileData;
		mui.showLoading('加载中...');
    
		canvasInit();
		function canvasInit() {
			  document.body.addEventListener("touchstart", function() {
			        event.preventDefault(); //手指滑动时，浏览器会上下左右翻屏
			      });
				document.body.addEventListener("touchmove", function() {
				      event.preventDefault(); //手指滑动时，浏览器会上下左右翻屏
				    });
				var oCanvas = document.getElementById("canvas");
				oCanvas.width = 300;
				oCanvas.height = 300;
				var cxt = oCanvas.getContext("2d");
				cxt.lineWidth = 3;
				var posX = 0; //x坐标
				var posY = 0; //y坐标
				var position = null;
	
				//手指触摸屏幕可记录此时的位置作为起点
				oCanvas.addEventListener("touchstart", function() {
					var canvas = $('#canvas');
					var boxX=canvas.offset().left;
					var boxY=canvas.offset().top;
					posX = event.changedTouches[0].pageX - boxX;
					posY = event.changedTouches[0].pageY - boxY;
					console.log(posX, posY)
					cxt.moveTo(posX, posY);
				});
	
				//手指屏滑动画线
				oCanvas.addEventListener("touchmove", function() {
			        var canvas = $('#canvas');
			        var boxX=canvas.offset().left;
			        var boxY=canvas.offset().top;
			        posX = event.changedTouches[0].pageX - boxX;
			        posY = event.changedTouches[0].pageY - boxY;
			        cxt.lineTo(posX, posY);
			        cxt.stroke();
			      });
			
			mui('.canvas_btn').on('tap','span',function(e) {
				if($(e.target).hasClass('canvas_reset')) {
					cxt.clearRect(0, 0, oCanvas.width, oCanvas.height);
					cxt.beginPath();
				}else {
					var strDataURI = oCanvas.toDataURL();
					console.log(strDataURI);
					$('.sign_modal').hide();
					$('body').css('overflow','auto');
					signfileData = strDataURI;
					if(isShowAngree) {
						$('.htsp_modal_ty .sign_img img').attr('src',strDataURI);
					}else {
						$('.htsp_modal_jj .sign_img img').attr('src',strDataURI);
					}
				}
			})
			mui('.footer_submit').on('tap', '.btn_submit', function () {
					isShowAngree = true;
			    $('.htsp_modal_ty').show();
					// $('body').css('overflow','hidden');body_class
					$('body').addClass('body_class');
					$('.mui-content').addClass('overFlow_conten');
			});
			mui('.footer_submit').on('tap', '.btn_cancell', function () {
			    $('.htsp_modal_jj').show();
					// $('body').css('overflow','hidden');
					$('body').addClass('body_class');
					$('.mui-content').addClass('overFlow_conten');
			});
			
			mui('.mui-modal_all_title').on('tap', '.mui-icon-close', function () {
					isShowAngree = false;
			    $('.htsp_modal_ty').hide();
			    $('.htsp_modal_jj').hide();
					$('.sign_modal').hide();
					$('body').css('overflow','auto');
					cxt.clearRect(0, 0, oCanvas.width, oCanvas.height);
					cxt.beginPath();
					$('.mui-content').removeClass('overFlow_conten');
					$('body').removeClass('body_class');
			});
			
			mui('.modal_btn').on('tap', '.ok', function () {
			    // var btnArray = ['取消', '确认'];
			    // mui.confirm('确认审核通过吗，确认？', '审核通过', btnArray, function (e) {
			    //     if (e.index == 1) {
			            
			    //     }
			    // })
					SaveEOption(1);
					isShowAngree = false;
					$('.mui-content').removeClass('overFlow_conten');
					$('body').removeClass('body_class');
			});
			
			
			mui('.modal_btn').on('tap', '.cancel', function () {
			    // var btnArray = ['取消', '确认'];
			    // mui.confirm('确认审核驳回吗，确认？', '审核驳回', btnArray, function(e) {
			    //     if (e.index == 1) {
			           
			    //     }
			    // });
					 SaveEOption(-1);
					 $('.mui-content').removeClass('overFlow_conten');
					 $('body').removeClass('body_class');
			});
			
			mui('.htsp_modal_jj').on('tap','.sign_img',function() {
				$('.sign_modal').show();
				$('body').css('overflow','hidden');
			})
			mui('.htsp_modal_ty').on('tap','.sign_img',function() {
				$('.sign_modal').show();
				$('body').css('overflow','hidden');
			})
		}

    function upload(formData) {
    	var url = '/api/Home/UpLoadImageBase64';
    	return request.post(url, formData).then(function(res) {
				console.log('文件上传',res);
    		if (res.code == 200) {
    			return res.data.FilePath;
    		}else {
					mui.alert('上传失败！');
				}
    	})
    }

    var fid = common.getQueryUrl("fid");
    var ftype = common.getQueryUrl("ftype");
    var template = 0;

    console.log("fid:" + fid);
    console.log("ftype:" + ftype);

    function showcontent() {
        $(".message_title").html("");
        $(".fjl").remove();
        switch (parseInt(ftype)) {
            case 1://用车审批
                console.log("用车审批");
                $(".mui-title").html("用车审批");
                getCarApplyDetail();
                break;
            case 2://发票审批
                console.log("发票审批");
                $(".mui-title").html("发票审批");
                getInvoiceApplysDetail();
                break;
            case 3://借款审批
                console.log("借款审批");
                $(".mui-title").html("借款审批");
                getBorrowMoneyDetail();
                break;
            case 4://专家费审批
                console.log("专家费审批");
                $(".mui-title").html("专家费审批");
                getExpertFeeDetail();
                break;
                //case 5://转正审批
                //    break;
                //case 6://离职审批
                //    break;
            case 7://用章审批
                $(".mui-title").html("用章审批");
                getSealApply();
                break;
            //case 8://资质借用审批
            //    break;
            case 9://报销审批
                console.log("报销审批");
                $(".mui-title").html("报销审批");
                getReimbursementDetail();
                break;
            case 10://付款审批
                console.log("付款审批");
                $(".mui-title").html("付款审批");
                getPayMoneyDetail();
                break;
            case 11://预付款申请
                console.log("预付款申请");
                $(".mui-title").html("预付款申请");
                getAdvanceMoneyDetail();
                break;
            case 12://预付款核销
                console.log("预付款核销");
                $(".mui-title").html("预付款核销");
                getAdvanceOffMoneyDetail();
                break;
                //case 13://用人审批
                //    break;
            case 102://投标申请审批
                console.log("投标申请审批");
                $(".mui-title").html("投标申请审批");
                getXMTBDetail();
                break;
            case 103://合同审批
                console.log("合同审批");
                $(".mui-title").html("合同审批");
                getHTSPDetail();
                break;
            case 104://任务单审批
                console.log("任务单审批");
                $(".mui-title").html("任务单审批");
                getRWDDetail();
                break;
                //case 209://资格预审文件审批
                //    break;
            case 301://成果文件审批
                console.log("成果文件审批");
                $(".mui-title").html("成果文件审批");
                getOutcomeDoc();
                break;
                //case 701://典型案例
                //    break;
                //case 801://优秀员工
                //    break;

                //case 901://任务接收_任务单_接收人
                //    break;
                //case 902://任务接收_项目进度_负责人
                //    break;
                //case 903://任务接收_项目进度_主要人
                //    break;
                //case 904://任务接收_项目进度_参与人
                //    break;
                //case 905://任务接收_投标申请_负责人
                //    break;
                //case 906://任务接收_投标申请_主要人员
                //    break;
            default:
                $(".mui-title").html("");
                mui.alert("待完成");
                break;
        }
		}

    function getDetail() {
        var url = '/api/';
        request.post(url, {
            Id: fid
        }).then(function (res) {
            console.log(res)
            if (res.code == 200) {
                var data = res.data;
								if(!data.id) {
									mui.alert('加载数据失败！','',function() {
										mui.back();
									});
									return;
								}
								common.arrObjTrimAndNull(data);
                var html = "";
                html += row("", data);

                html += spimg(data.State);

                $(".message_title").html(html);

                template = data.Template;
            }else {
							mui.alert('系统错误：'+ res.msg)
						}
        }).then(processflow);
    }

    //用车审批 1
    function getCarApplyDetail() {
        var url = '/api/Resource/FillCarRecord';
        request.post(url, {
            Id: fid
        }).then(function (res) {
            console.log(res)
            if (res.code == 200) {
                var data = res.data;
								if(JSON.stringify(data) == "{}") {
									mui.alert('加载数据失败！','',function() {
										mui.back();
									});
									return;
								}
								common.arrObjTrimAndNull(data);
                var html = "";
                html += row("车牌号：", data.CarStr);
                html += row("出车时间：", data.StartTime);
                html += row("返回时间：", data.EndTime);
                html += row("申请人：", data.ApplyUser);
                html += row("用车目的地：", data.Address);
                html += row("用车事由：", data.ApplyReason);

                html += spimg(data.State);

                $(".message_title").html(html);

                template = data.Template;
            }else {
							mui.alert('系统错误：'+ res.msg)
						}
        }).then(processflow);
    }

    //发票审批 2
    function getInvoiceApplysDetail() {
        var url = '/api/Finance/InvoiceApplysDetail';
        request.post(url, {
            Id: fid
        }).then(function (res) {
            console.log(res)
            if (res.code == 200) {
                var data = res.data;
								if(JSON.stringify(data) == "{}") {
									mui.alert('加载数据失败！','',function() {
										mui.back();
									});
									return;
								}
                var html = "";
                html += row("项目名称：", data.ProjectName);
                html += row("合同名称：", data.CName);
                html += row("合同编号：", data.CNumber);
                html += row("合同金额：", data.CPrice);
                html += row("委托单位：", data.PUnit);
                html += row("中标单位：", data.WinBUnit);
                html += row("付款单位：", data.PaymentUnit_Str);
                html += row("发票备注信息：", data.InRemark);
                html += row("开票内容：", data.InContent);
                html += row("开票金额（元）：", data.Price);
                html += row("开票金额大写（元）：", data.PriceText);
                html += row("发票类型：", data.InType_Str);
                html += row("开票类型：", data.Category_Str);
								if(data.Category) {
									html += row("开票单位名称：", data.IUoffice);
									html += row("纳税人识别号：", data.TINumber);
									html += row("地址：", data.Address);
									html += row("电话：", data.Tel);
									html += row("开户行：", data.Bank);
									html += row("账号：", data.BankNumber);
								}
                

                html += spimg(data.State);

                $(".message_title").html(html);
								var html_2 = "";
								if (data.lstFile_Invoice.length > 0) {
								    
								    html_2 += '<div class="file_title">中标通知书复印件</div>';
										html_2 += '<ul class="message_title fjl">';
								    for (var i = 0; i < data.lstFile_Invoice.length; i++) {
								        html_2 += row("文件名：", '<span class="file_name" path='+ 
												data.lstFile_Invoice[i].FilePath +'>' 
												+ data.lstFile_Invoice[i].FileName + '.' +
												data.lstFile_Invoice[i].FilePath.split('.')[1] + '</span>');
								    }
										html_2 += "</ul>";
								}
								if (data.lstFile_InvoiceImg.length > 0) {
								    html_2 += '<div class="file_title">发票抬头二维码</div>';
										html_2 += '<ul class="message_title fjl">';
								    for (var i = 0; i < data.lstFile_InvoiceImg.length; i++) {
								        html_2 += row("文件名：", '<span class="file_name" path='+ 
												data.lstFile_InvoiceImg[i].FilePath +'>' 
												+ data.lstFile_InvoiceImg[i].FileName + '.' +
												data.lstFile_InvoiceImg[i].FilePath.split('.')[1] + '</span>');
								    }
										html_2 += "</ul>";
								}
								$(".message_title").after(html_2);
                template = data.Template;
            }else {
							mui.alert('系统错误：'+ res.msg)
						}
        }).then(processflow);
    }

    //借款审批 3
    function getBorrowMoneyDetail() {
        var url = '/api/Finance/BorrowMoneyDetail';
        request.post(url, {
            Id: fid
        }).then(function (res) {
            console.log(res)
            if (res.code == 200) {
                var data = res.data;
								if(JSON.stringify(data) == "{}") {
									mui.alert('加载数据失败！','',function() {
										mui.back();
									});
									return;
								}
								common.arrObjTrimAndNull(data);
                var html = "";
                html += row("申请部门：", data.BorrowUnit);
                html += row("借款金额：", data.Total + "元");
                html += row("借款用途：", data.Reason);
                html += row("付款方式：", data.BorrowType_Str);
                html += row("支票号码：", data.CheckNum);
                html += row("借用时间：", data.BeginTime + "至" + data.EndTime);
                html += row("预计归还日期：", data.ReimTime);
                html += row("领款人：", data.Payee);
                html += row("申请人：", data.ApplyUser);
                html += row("明细：", '<pre>'+data.Remark+'</pre>');
                html += spimg(data.State);

                $(".message_title").html(html);
								
                if (data.lstFile.length > 0) {
                    var html_2 = "";
                    html_2 += '<div class="file_title">附件</div>';
										html_2 += '<ul class="message_title fjl">';
                    for (var i = 0; i < data.lstFile.length; i++) {
                       html_2 += row("文件名：", '<span class="file_name" path='+
                       data.lstFile[i].FilePath +'>' 
                       + data.lstFile[i].FileName + 
                       data.lstFile[i].Extension + '</span>');
                    }
										html_2 += "</ul>";
                    $(".message_title").after(html_2);
                }

                template = data.Template;
            }else {
							mui.alert('系统错误：'+ res.msg)
						}
        }).then(processflow);
    }

    //专家费审批 4
    function getExpertFeeDetail() {
        var url = '/api/Finance/ExpertFeeDetail';
        request.post(url, {
            Id: fid
        }).then(function (res) {
            console.log(res)
            if (res.code == 200) {
                var data = res.data;
								if(JSON.stringify(data) == "{}") {
									mui.alert('加载数据失败！','',function() {
										mui.back();
									});
									return;
								}
								common.arrObjTrimAndNull(data);
                var html = "";
                html += row("项目名称：", data.ProjectName);
                html += row("申请金额（元）：", data.CostTotal);

                html += spimg(data.State);

                $(".message_title").html(html);

                template = data.Template;
            }else {
							mui.alert('系统错误：'+ res.msg)
						}
        }).then(processflow);
    }

    //用章审批 7
    function getSealApply() {
        var url = '/api/Resource/FillSealApply';
        request.post(url, {
            Id: fid
        }).then(function (res) {
            console.log(res)
            if (res.code == 200) {
                var data = res.data;
								if(JSON.stringify(data) == "{}") {
									mui.alert('加载数据失败！','',function() {
										mui.back();
									});
									return;
								}
								common.arrObjTrimAndNull(data);
                var html = "";
                html += row("申请部门：", common.getNotNullData(data.modelRS.RDepartmentName));
                html += row("用章时间：", common.getNotNullData(data.modelRS.SealTime));
                html += row("文件名称：", common.getNotNullData(data.modelRS.Docment));
                html += row("文件数量：", common.getNotNullData(data.modelRS.DocNumber));
                html += row("项目名称：", common.getNotNullData(data.modelRS.ProjectName));
                html += row("电子章：", common.getNotNullData(data.modelRS.ElectronicaName));
                html += row("物理章：", common.getNotNullData(data.modelRS.PhysicsName));
                html += row("备注：", common.getNotNullData(data.modelRS.Remark));
                html += spimg(data.modelRS.State);
                $(".message_title").html(html);

                if (data.lstFile.length > 0) {
                    var html_2 = "";
                   html_2 += '<div class="file_title" >附件</div>';
                   html_2 += '<ul class="message_title fjl">';
                    for (var i = 0; i < data.lstFile.length; i++) {
                        html_2 += row("文件名：", '<span class="file_name" path='+ data.lstFile[i].FilePath +'>' + data.lstFile[i].Name + data.lstFile[i].FileFormat + '</span>');
                    }
										html_2 += "</ul>";
                    $(".message_title").after(html_2);
                }

                template = data.modelRS.Template;
            }else {
							mui.alert('系统错误：'+ res.msg)
						}
        }).then(processflow);
    }

    //报销审批 9
    function getReimbursementDetail() {
        var url = '/api/Finance/ReimbursementDetail';
        request.post(url, {
            Id: fid
        }).then(function (res) {
            console.log(res)
            if (res.code == 200) {
                var data = res.data;
								if(JSON.stringify(data) == "{}") {
									mui.alert('加载数据失败！','',function() {
										mui.back();
									});
									return;
								}
								common.arrObjTrimAndNull(data);
                var html = "";
                html += row("报销部门：", common.getNotNullData(data.Department));
                html += row("当前时间：", common.getNotNullData(data.CreateDate));
                html += row("报销方式：", common.getNotNullData(data.Way_Str));
                html += row("领款人：", common.getNotNullData(data.Payee));
                html += row("报销事由：", common.getNotNullData(data.CauseMatter));
                if (data.Way == 1) {//如果报销方式选择的是冲销借款
                    html += row("借款流程：", common.getNotNullData(data.ExplainDetail.Title));
                    html += row("借款金额：", (data.ExplainDetail.Total || 0) + "元");
                    html += row("借款事由：", common.getNotNullData(data.ExplainDetail.Reason));
                }
                html += spimg(data.State);
                $(".message_title").html(html);

                if (data.DetailsList.length > 0) {
                    var html_2 = "";
                    html_2 += '<div class="file_title">明细</div>';
                    for (var i = 0; i < data.DetailsList.length; i++) {
                        html_2 += '<ul class="message_title fjl" style="margin-top: 5px;">';
                        html_2 += row("费用日期：", data.DetailsList[i].CostTime);
                        html_2 += row("费用科目：", data.DetailsList[i].CostType);
                        html_2 += row("费用说明：", data.DetailsList[i].CostExplain);
                        //html_2 += row("票据：", data.File.FileName,data.File.FilePath);
                        html_2 += row("金额：", data.DetailsList[i].Amount + "元");
												var lists = data.DetailsList[i].lstFile;
												if(lists.length > 0) {
													html_2 += '<div class="file_title" style="padding-left: 0">附件</div>';
													html_2 += '<ul class="message_title fjl" style="padding: 0">';
													
													for (var j = 0; j < lists.length; j++) {
													   html_2 += row("文件名：", '<span class="file_name" path='+
													   lists[j].FilePath +'>' 
													   + lists[j].FileName + '.' + lists[j].FilePath.split('.')[1] + '</span>');
													}
													html_2 += "</ul>";
												}
												html_2 += "</ul>";
                    }
                    $(".message_title").after(html_2);
                }

                template = data.Template;
            }else {
							mui.alert('系统错误：'+ res.msg)
						}
        }).then(processflow);
    }

    //付款审批 10
    function getPayMoneyDetail() {
        var url = '/api/Finance/PayMoneyDetail';
        request.post(url, {
            Id: fid
        }).then(function (res) {
            console.log(res)
            if (res.code == 200) {
                var data = res.data;
								if(JSON.stringify(data) == "{}") {
									mui.alert('加载数据失败！','',function() {
										mui.back();
									});
									return;
								}
								common.arrObjTrimAndNull(data);
                var html = "";
                html += row("项目名称：", data.ProjectName);
                html += row("收款人：", data.ReceivableUser);
                html += row("付款方式：", data.Way_Str);
                html += row("联系人：", data.LMan);
                html += row("联系电话：", data.LPhone);
                html += row("开户行：", data.Bank);
                html += row("银行账号：", data.BankNum);
                html += row("项目总金额：", data.Total + "元");
                html += row("申请金额：", data.APrice + "元");
                html += row("已支付金额：", data.YPrice + "元");
                html += row("未支付金额：", data.SPrice + "元");
                html += row("备注：", (data.IsPC ? "签订合同，" : "") + (data.IsFP ? "收到发票" : ""));
                html += row("申请部门：", data.ApplyUnit);
                html += row("申请人：", data.ApplyUser);
                html += row("明细：", data.Remark);
                html += spimg(data.State);
                $(".message_title").html(html);

                if (data.lstFile.length > 0) {
                    var html_2 = "";
                    html_2 += '<div class="file_title">附件</div>';
                    html_2 += '<ul class="message_title fjl">';
                    for (var i = 0; i < data.lstFile.length; i++) {
                        html_2 += row("文件名：", '<span class="file_name" path='+
                        data.lstFile[i].FilePath +'>' 
                        + data.lstFile[i].FileName + 
                        data.lstFile[i].Extension + '</span>');
                    }
										 html_2 += "</ul>";
                    $(".message_title").after(html_2);
                }

                template = data.Template;
            }else {
							mui.alert('系统错误：'+ res.msg)
						}
        }).then(processflow);
    }

    //预付款申请 11
    function getAdvanceMoneyDetail() {
        var url = '/api/Finance/AdvanceMoneyDetail';
        request.post(url, {
            Id: fid
        }).then(function (res) {
            console.log(res)
            if (res.code == 200) {
                var data = res.data;
								if(JSON.stringify(data) == "{}") {
									mui.alert('加载数据失败！','',function() {
										mui.back();
									});
									return;
								}
								common.arrObjTrimAndNull(data);
                var html = "";
                html += row("项目名称：", common.getNotNullData(data.ProjectName));
                html += row("收款人：", common.getNotNullData(data.ReceivableUser));
                html += row("付款方式：", common.getNotNullData(data.Way_Str));
                html += row("联系人：", common.getNotNullData(data.LMan));
                html += row("联系电话：", common.getNotNullData(data.LPhone));
                html += row("开户行：", common.getNotNullData(data.Bank));
                html += row("银行账号：", common.getNotNullData(data.BankNum));
                html += row("项目总金额：", data.Total + "元");
                html += row("申请金额：", data.APrice + "元");
                html += row("已支付金额：", data.YPrice + "元");
                html += row("未支付金额：", data.SPrice + "元");
                html += row("备注：", data.IsPC ? "签订合同" : "");
                html += row("发票收到日期(预计)：", common.getNotNullData(data.FPDate));
                html += row("申请部门：", common.getNotNullData(data.ApplyUnit));
                html += row("申请人：", common.getNotNullData(data.ApplyUser));
                html += row("明细：", common.getNotNullData(data.Remark));
                html += spimg(data.State);
                $(".message_title").html(html);

                if (data.lstFile.length > 0) {
                    var html_2 = "";
                    html_2 += '<div class="file_title">附件</div>';
                    html_2 += '<ul class="message_title fjl">';
                    for (var i = 0; i < data.lstFile.length; i++) {
                       html_2 += row("文件名：", '<span class="file_name" path='+
                       data.lstFile[i].FilePath +'>' 
                       + data.lstFile[i].FileName + 
                       data.lstFile[i].Extension + '</span>');
                    }
										 html_2 += "</ul>";
                    $(".message_title").after(html_2);
                }

                template = data.Template;
            }else {
							mui.alert('系统错误：'+ res.msg)
						}
        }).then(processflow);
    }

    //预付款核销 12
    function getAdvanceOffMoneyDetail() {
        var url = '/api/Finance/AdvanceOffMoneyDetail';
        request.post(url, {
            Id: fid
        }).then(function (res) {
            console.log(res)
            if (res.code == 200) {
                var data = res.data;
								if(JSON.stringify(data) == "{}") {
									mui.alert('加载数据失败！','',function() {
										mui.back();
									});
									return;
								}
								common.arrObjTrimAndNull(data);
                var html = "";
                html += row("核销收款人：",common.getNotNullData(data.OffUser));
                html += row("核销金额：", data.OffTotal + "元");
                html += row("核销内容：", common.getNotNullData(data.OffContent));
                html += row("备注：", common.getNotNullData(data.Remark));
                html += spimg(data.State);
                $(".message_title").html(html);

                if (data.lstFile.length > 0) {
                    var html_2 = "";
                   html_2 += '<div class="file_title">附件</div>';
                   html_2 += '<ul class="message_title fjl">';
                    for (var i = 0; i < data.lstFile.length; i++) {
                        html_2 += row("文件名：", '<span class="file_name" path='+
                        data.lstFile[i].FilePath +'>' 
                        + data.lstFile[i].FileName + 
                        data.lstFile[i].Extension + '</span>');
                    }
										 html_2 += "</ul>";
                    $(".message_title").after(html_2);
                }

                template = data.Template;
            }else {
							mui.alert('系统错误：'+ res.msg)
						}
        }).then(processflow);
    }

    //投标申请审批 102
    function getXMTBDetail() {
        var url = '/api/BusinessManage/XMTBDetail';
        request.post(url, {
            ProjectId: fid
        }).then(function (res) {
            console.log(res)
            if (res.code == 200) {
                var data = res.data;
								if(JSON.stringify(data) == "{}") {
									mui.alert('加载数据失败！','',function() {
										mui.back();
									});
									return;
								}
								common.arrObjTrimAndNull(data);
                var html = "";
                if (data.State == 2) {
                    html += row("投标文件编号：", data.Number);
                }
                html += row("项目名称：", data.ProjectName);
                html += row("项目编号：", data.ProjectNumber);
                html += row("业务类型：", data.YWLX_Str);
                html += row("保证金/保函要求：", data.CallBid_Requirement_Str);
                html += row("项目负责人：", data.FZR_Str);
                html += row("主要人员：", data.ZYRY_Str);
                html += row("盖章位置及要求：", data.Bid_StampRequirement);
                html += row("盖章文件份数：", data.Bid_StampCount);
                html += row("电子章：", data.DZZ_Str);
                html += row("物理章：", data.WLZ_Str);
                html += row("原借用时间：", data.Bid_OriginalBegin + "至" + data.Bid_OriginalEnd);
                if (data.CallBid_Requirement == 1) {
                    html += row("保证金金额：", data.Cash_Price + "元");
                    html += row("递交截止时间：", data.Cash_SubmitTime);
                    html += row("收款单位(全称)：", data.Cash_Unit);
                    html += row("收款单位开户行：", data.Cash_BankName);
                    html += row("收款单位银行账号：", data.Cash_BankAccount);
                    html += row("总公司转出形式：", data.Cash_CompanyTrans_Str);
                    html += row("分公司转总公司形式：", data.Cash_ChildCompanyTrans_Str);
                    html += row("备注：", data.Cash_Remark);
                }
                else if (data.CallBid_Requirement == 2) {
                    html += row("保函金额：", data.Guarantee_Price + "元");
                    html += row("递交截止时间：", data.Guarantee_SubmitTime);
                    html += row("开具机构：", data.Guarantee_Unit);
                    html += row("保函有效期：", data.Guarantee_PeriodBegin + "至" + data.Guarantee_PeriodEnd);
                    html += row("保函接收人： ", data.Guarantee_Receiver);
                    html += row("接收人联系方式：", data.Guarantee_Tel);
                    html += row("接收人地址：", data.Guarantee_ReceiverAddress);
                    html += row("备注：", data.Guarantee_Remark);
                }
                html += spimg(data.State);
                $(".message_title").html(html);
								
								if (data.lstFile.length > 0) {
								    var html_2 = "";
								    html_2 += '<div class="file_title">附件</div>';
										html_2 += '<ul class="message_title fjl">';
								    for (var i = 0; i < data.lstFile.length; i++) {
								       html_2 += row(data.lstFile[i].Type + "：", '<span class="file_name row_span" path='+
								       data.lstFile[i].FilePath +'>' 
								       + data.lstFile[i].FileName + 
								       data.lstFile[i].Extension + '</span>');
								    }
										html_2 += "</ul>";
								    $(".message_title").after(html_2);
								}

                template = data.Template;
            }else {
							mui.alert('系统错误：'+ res.msg)
						}
        }).then(processflow);
    }

    //合同审批 103
    function getHTSPDetail() {
        var url = '/api/BusinessManage/HTSPDetail';
        request.post(url, {
            Id: fid
        }).then(function (res) {
            console.log(res)
            if (res.code == 200) {
                var data = res.data;
								if(JSON.stringify(data) == "{}") {
									mui.alert('加载数据失败！','',function() {
										mui.back();
									});
									return;
								}
								common.arrObjTrimAndNull(data);
                var html = "";
                html += row("合同名称：", data.Name);
                if (data.State == 2) {
                    html += row("合同编号：", data.Number);
                }
                html += row("合同相对方：", data.ConstructionUnit);
                html += row("收款方式：", data.PaymentType_Str);
                html += row("合同类型：", data.Type_Str);
                html += row("合同金额：", data.Price + "元");
                html += row("合同工期：", data.BeginTime + "至" + data.EndTime);
                html += row("合同主要条款：", data.Contents);
                html += row("备注：", data.ApprovalRemark);
                html += row("电子章：", data.DZZ_Str);
                html += row("物理章：", data.WLZ_Str);
                html += row("盖章文件份数：", data.StampCount);
                html += spimg(data.State);

                $(".message_title").html(html);
								 var html_2 = "";
								if (data.lstFile_ContractFile.length > 0) {
								    html_2 += '<div class="file_title">合同文件</div>';
										html_2 += '<ul class="message_title fjl">';
								    for (var i = 0; i < data.lstFile_ContractFile.length; i++) {
								       html_2 += row("文件名：", '<span class="file_name" path='+
								       data.lstFile_ContractFile[i].FilePath +'>' 
								       + data.lstFile_ContractFile[i].FileName + 
								       data.lstFile_ContractFile[i].Extension + '</span>');
								    }
										html_2 += "</ul>";
								}
								if (data.lstFile_ContractAttach.length > 0) {
								    html_2 += '<div class="file_title">合同-附件</div>';
										html_2 += '<ul class="message_title fjl">';
								    for (var i = 0; i < data.lstFile_ContractAttach.length; i++) {
								       html_2 += row("文件名：", '<span class="file_name" path='+
								       data.lstFile_ContractAttach[i].FilePath +'>' 
								       + data.lstFile_ContractAttach[i].FileName + 
								       data.lstFile_ContractAttach[i].Extension + '</span>');
								    }
										html_2 += "</ul>";
								}
								$(".message_title").after(html_2);

                template = data.Template;
            }else {
							mui.alert('系统错误：'+ res.msg)
						}
        }).then(processflow);
    }

    //任务单审批 104
    function getRWDDetail() {
        var url = '/api/BusinessManage/RWDDetail';
        request.post(url, {
            ProjectId: fid
        }).then(function (res) {
            console.log(res)
            if (res.code == 200) {
                var data = res.data;
								if(JSON.stringify(data) == "{}") {
									mui.alert('加载数据失败！','',function() {
										mui.back();
									});
									return;
								}
								common.arrObjTrimAndNull(data);
                var html = "";
                html += row("项目名称：", data.ProjectName);
                html += row("项目编号：", data.ProjectNumber);
                html += row("客户名称：", data.ConstructionUnit);
                html += row("执行时间：", data.BeginTime + "至" + data.EndTime);
                if (data.Receiver_Str != "") {
                    html += row("项目接收人：", data.Receiver_Str);
                }
                html += row("工作内容：", data.WorkContents);
                html += row("工作要求：", data.WorkRequire);
                html += row("合同选择：", data.Contract.Name == undefined ? "无" : data.Contract.Name);
                html += spimg(data.State);
                $(".message_title").html(html);

                if (data.lstFile.length > 0) {
                    var html_2 = "";
                    html_2 += '<div class="file_title" style="padding-left: 0">附件</div>';
                    html_2 += '<ul class="message_title fjl" style="padding: 0">';
                    for (var i = 0; i < data.lstFile.length; i++) {
                        html_2 += row("文件名：", '<span class="file_name" path='+ data.lstFile[i].FilePath +'>' + data.lstFile[i].FileName + data.lstFile[i].Extension + '</span>');
                    }
										 html_2 += "</ul>";
                    $(".message_title").after(html_2);
                }

                template = data.Template;
            }else {
							mui.alert('系统错误：'+ res.msg)
						}
        }).then(processflow);
    }

    //成果文件审批 301
    function getOutcomeDoc() {
        var url = '/api/CostConsult/GetOutcomeDoc';
        request.post(url, {
            ID: fid
        }).then(function (res) {
            console.log(res)
            if (res.code == 200) {
                var data = res.data;
								if(JSON.stringify(data) == "{}") {
									mui.alert('加载数据失败！','',function() {
										mui.back();
									});
									return;
								}
								common.arrObjTrimAndNull(data);
                var html = "";
                html += row("成果文件名称：", data.Name);
                html += row("成果文件类型：", data.Number);
                html += row("成果文件编制日期：", data.MakeDate);
                html += row("备注：", data.Remarks);
                html += spimg(data.State);

                $(".message_title").html(html);
								
								if (data.lstFile.length > 0) {
								    var html_2 = "";
								    html_2 += '<div class="file_title">附件</div>';
								    html_2 += '<ul class="message_title fjl">';
								    for (var i = 0; i < data.lstFile.length; i++) {
								        html_2 += row("文件名：", '<span class="file_name" path='+ data.lstFile[i].FilePath +'>' + data.lstFile[i].Name + data.lstFile[i].FileFormat + '</span>');
								        
								    }
										html_2 += "</ul>";
								    $(".message_title").after(html_2);
								}

                template = data.Template;
            }else {
							mui.alert('系统错误：'+ res.msg)
						}
        }).then(processflow);
    }

    function row(title, content) {
        return "<li><p>" + title + "</p><div>" + content + "</div></li>";
    }
		
		common.promise().then(function() {
			mui.showLoading('加载中...')
		}).then(function() {
			return showcontent();
		}).then(function() {
		})
		
    //显示审批状态图片
    function spimg(state) {
        switch (state) {
            case 1:
                return '<img class="htsp_zt"  src="../../img/htsp_zt_spz.png"/>';
            case 2:
                return '<img class="htsp_zt" src="../../img/htsp_zt_tg.png" />';
            case -1:
                return '<img class="htsp_zt"  src="../../img/htsp_zt_wtg.png"/>';
        }
        return "";
    }

    //显示审批流程
    function processflow() {
        if (template == 0) {
            return;
        }
        var url = '/api/SystemManage/ApplyView';
        request.post(url, {
            Id: template
        }).then(function (res) {
            console.log(res)
            if (res.code == 200) {
                var html = '';
                for (var i = 0; i < res.data.list.length; i++) {
                	var item = res.data.list[i];
                	var color = '';
                	if(item.eStatus == -1) {
                		color = 'red';
                	}
                	if(item.eStatus == 0) {
                		color = 'orange';
                	}
                	if(item.eStatus == 1) {
                		color = 'green';
                	}
                	if(item.eStatus == 2 || item.eStatus == 3) {
                		color = 'red';
                	}
                	html += '<li><div class="procedure_left"><span>' + item.title +
                		'</span><i></i></div>' +
                		'<div class="procedure_right"><p class="start_check">' + item.detail + '<span class='+ color +'>' + item.tempStatus + '</span></p>'+
                		(item.eDateTime == '无' ? '' : '<span class="opa_time">'+ item.eDateTime +'</span>') +
                		(item.content ? '<p class="contents"><span>' + item.content + '</span></p>' : '')+
										(item.signFilePath != '' ? ('<p>签名：<img src='+ baseUrl + item.signFilePath +' ></p>') : '') + 
                		'</div></li>'
                }
                $('.list_content_procedure').html(html);
                if (res.data.isAudit) {
                    $(".footer_submit").show();
                } else {
                    $(".footer_submit").hide();
                }
								var this_length = $('.list_content_procedure').find('li').length;
								for(var i=0;i<this_length;i++) {
									var li = $('.list_content_procedure').find('li').eq(i);
									$(li).find('.procedure_left').css('height',$(li).css('height'))
								}
            }else {
							mui.alert('系统错误：'+ res.msg)
						}
						mui.hideLoading()
        });
    }

    //审批通过，-1驳回，1通过，2越级审批
    function SaveEOption(state) {
        var url = '/api/SystemManage/SaveEOption';
        var eopinion = "";
        if (state == 1) {
            eopinion = $("#opinionok").val();
        } else if (state == -1) {
            eopinion = $("#opinioncancel").val();
        }
        if (eopinion == "") {
            mui.alert("请填写审批意见！");
            return;
        }
				
				common.promise().then(function() {
					var data = {
						strBase64: signfileData
					}
					return upload(data);
				}).then(function(res) {
					console.log(res)
					request.post(url, {
					    Id: template,
					    EOpinion: eopinion,
					    EStatus: state,
							SignFilePath: res
					}).then(function (res) {
					    console.log(res)
					    if (res.code == 200) {
					        $('.htsp_modal_ty').hide();
					        $('.htsp_modal_jj').hide();
					        $("#opinionok").val("");
					        $("#opinioncancel").val("");
					        showcontent();
					    }else {
								mui.alert('系统错误：'+ res.msg)
							}
					});
				})
				
        
    }

		//预览
		mui('.mui-content').on('tap','.file_name',function() {
				mui.showLoading('加载中...');
			var path = $(this).attr('path');
			console.log(path)
			openFile(baseUrl + path);
		})

</script>
