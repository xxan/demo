<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="../../css/comon.css" />
		<link rel="stylesheet" type="text/css" href="../../css/xmgl_detail.css" />
		<link rel="stylesheet" type="text/css" href="../../css/mui.picker.min.css"/>
		<link rel="stylesheet" type="text/css" href="../../css/menu.css"/>
		<script src="../../js/polyfill.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/mui.js"></script>
		<style type="text/css">
			.content_info {
				height: auto !important;
			}
			.mui-bar-nav~.mui-content .mui-slider.mui-fullscreen {
			    top: 210px;
			}
			.mui-scroll{
				/* height: 100%; */
			}
			.task_point_item {
				position: relative;
			}
			.meau_list .list_table {
				padding-top: 0;
			}
			
			.btn_box_meau {
				position: absolute;
				bottom: 0;
				width: 100%;
				text-align: center;
				background: white;
			}
			.show_elec {
				height: 100%;
				overflow: scroll;
			}
			.btn_box_meau button {
				width: 100px;
			}
			
			.meau_list .list_table .items  {
				overflow: scroll;
			}
		</style>
		<script type="text/javascript" src="../../js/jquery.min.js">

		</script>
		<script type="text/javascript">
			mui.init({
				gestureConfig: {
					tap: true, //默认为true
					doubletap: true, //默认为false
					longtap: true, //默认为false
					swipe: true, //默认为true
					drag: true, //默认为true
					hold: true, //默认为false，不监听
					release: false //默认为false，不监听
				},
			})
		</script>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav header_box">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">项目详情</h1>
		</header>
		<p class="up_fress data-loading-icon">
			<button type="button" data-loading-icon="mui-spinner mui-spinner-custom" data-loading-text="刷新中" class="loading_btn"></button>
		</p>
		
		<div id="pullrefresh" class="mui-content mui-scroll-wrapper">
			<div class="mui-scroll">
				<div class="project_title_box">
					<h4 class="project_name">海淀区亮甲店保障房智慧工地项目</h4>
					<p>项目编号：<span class="project_number">1234</span></p>
					<div class="receivable">
						<p>已收款</p>
						<p><span class="get_money">12.34</span></p>
					</div>
					<div class="receivable_result">
						<p>是否收款完成</p>
						<p><span class="get_result_money">否</span></p>
					</div>
				</div>
				<div id="slider" class="mui-slider ">
					<div class="mui-slider detail_title_list">
						<div id="slider_title" class="mui-slider-indicator mui-segmented-control mui-segmented-control-inverted detail_title_list_title">
							<a class="mui-control-item" href="#item1">项目详情<span></span></a>
							<a class="mui-control-item" href="#item2">任务分配<span></span></a>
							<a class="mui-control-item" href="#item3">进度计划<span></span></a>
							<a class="mui-control-item" href="#item4">成果文件<span></span></a>
							<a class="mui-control-item" href="#item5">项目收尾<span></span></a>
						</div>
						<hr>
						<!-- <div id="sliderProgressBar" class="mui-slider-progress-bar mui-col-xs-2"></div> -->
					</div>
					<div class="mui-slider-group">	
						<div id="scroll1" >
							<div class="mui-slider-group detail_list_tab" id="detail_list">
								<div id="item1" class="mui-slider-item mui-control-content project_detail">
									<div class="mui-table-view project_detail_list">
										<p>
											<img src="../../img/detail.png" >
											项目详情
										</p>
										<div class="detail_info">
											
										</div>
									</div>
								</div>
								<div id="item2" class="mui-slider-item mui-control-content project_detail">
									<div class="mui-table-view project_detail_list project_task_point task_show">
										<p>
											<img src="../../img/rewu.png" >
											任务单
											<!-- <span class="add_point add_record">添加</span> -->
										</p>
										<div class="detail_info detail_info_no_data bid_no_data contract_no_data">
											<img src="../../img/no_data.png" >
											<p>未有数据</p>
										</div>
										<div class="detail_info contract_info" style="display: none;">
											<p>任务接收人：<span>项目管理</span></p>
											<p>执行时间：<span>2019-09-05 09:00 至 2019-09-06 09:00</span></p>
											<p>工作内容：<span>系统开发</span></p>
											<p>工作要求：<span>按时完成开发</span></p>
											<p>项目合同：<span>技术开发合同</span></p>
											<p>合同文件：<span class="file_name">合同.doc</span></p>
										</div>
									</div>
									
									<hr >
									
									<div class="mui-table-view project_detail_list project_task_point wtzl_show">
										<p>
											<img src="../../img/zliao.png" >
											委托资料
										</p>
										<div class="detail_info detail_info_no_data bid_no_data formwork_no_data">
											<img src="../../img/no_data.png" >
											<p>未有数据</p>
										</div>
										<div class="formwork_lists" style="display: none;">
											<div class="detail_info" >
												<p class="means_title">技术资料</p>
												<p>上传人员：<span>系统开发</span></p>
												<p>上传日期：<span>2019-09-05</span></p>
												<p>文件：<span class="file_name">技术资料.doc</span></p>
											</div>
											<div class="detail_info">
												<p class="means_title">技术资料</p>
												<p>上传人员：<span>系统开发</span></p>
												<p>上传日期：<span>2019-09-05</span></p>
												<p>文件：<span class="file_name">技术资料.doc</span></p>
											</div>
										</div>
									</div>
								</div>
								<div id="item3" class="mui-slider-item mui-control-content project_detail">
									<div class="mui-table-view project_detail_list">
										<p>
											<img src="../../img/people.png" >
											项目人员
										</p>
										<div class="detail_info project_member">
											<p>项目负责人</p>
											<div class="leader_list manager_names">
												<span>某某</span>
											</div>
										</div>
										<div class="detail_info project_member member_list">
											<p>主要人员</p>
											<div class="leader_list key_personnel">
												<span>某某</span>
												<span>某某</span>
											</div>
											<i class="member_add"></i>
										</div>
									</div>
									
									<hr >
									
									<div class="mui-table-view project_detail_list project_task_point">
										<p>
											<img src="../../img/jiedian.png" >
											任务节点
											<span class="add_point add_task_point">添加</span>
										</p>
										<div class="task_point_lists">
											<div class="detail_info detail_info_no_data bid_no_data">
												<img src="../../img/no_data.png" >
												<p>未有数据</p>
											</div>
										</div>
										
									</div>
								</div>
								<div id="item4" class="mui-slider-item mui-control-content project_detail">
							
									<div class="mui-table-view project_detail_list project_task_point">
										<p>
											<img src="../../img/result_file.png" >
											成果文件
											<span class="add_point">添加</span>
										</p>
										<div class="result_list_info">
											
											
										</div>
										
									</div>
								</div>
								<div id="item5" class="mui-slider-item mui-control-content project_detail">
								
									<div class="mui-table-view project_detail_list project_task_point">
										<p>
											<img src="../../img/recive.png" >
											成果文件签收
											<span class="add_point add_file_sign">添加</span>
										</p>
										<div class="show_files">
											<div class="detail_info">
												<p>签收日期：<span>2019-09-06</span></p>
												<p>签收单：<span class="file_name">原型.zip</span></p>
												<p>备注：<span>审批通过</span></p>
											</div>
										</div>
										
									</div>
									<hr >
									<div class="mui-table-view project_detail_list project_task_point">
										<p>
											<img src="../../img/evaluate.png" >
											业主评价
											<span class="add_point add_Owner_eva">添加</span>
										</p>
										<div class="evaluate">
											
										</div>
									</div>
									<hr >
									
									<div class="mui-table-view project_detail_list project_task_point">
										<p>
											<img src="../../img/evaluate2.png" >
											项目部人员评价
										</p>
										<div class="evaluate_list">
											<div class="detail_info">
												<p>姓名：<span>系统开发</span></p>
												<p>职务：<span>原型</span></p>
												<p>评价：<span>2019-09-06</span></p>
												<p>评价人：<span>未接受</span></p>
												<p>评价时间：<span>2019-09-06</span></p>
												<p class="btn_class"><span class="update_btn">评价</span></p>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			
		</div>
		<p class="down_fress data-loading-icon">
			<button type="button" data-loading-icon="mui-spinner mui-spinner-custom" data-loading-text="加载中" class="loading_btn"></button>
		</p>
		<div class="meau_list" id="meau_box">
			
			<div class="list_table spans mui-scroll">
				<div class="show_elec spans">
					<p>人员选择</p>
					<div class="ele_meal items spans">
						
					</div>
				</div>
				
				
				<p class="btn_box_meau">
					<button type="button" class="mui-btn meau_cancel spans">取消</button>
					<button type="button" class="mui-btn mui-btn-blue spans">确定</button>
				</p>
			</div>
		</div>
	</body>
	<script src="../../js/mui.pullToRefresh.js"></script>
	<script src="../../js/mui.pullToRefresh.material.js"></script>
	<script type="text/javascript" src="../../js/jquery.min.js"></script>
	<script src="../../js/mui.picker.min.js" type="text/javascript" charset="utf-8"></script>
	<script type="text/javascript" src="../../js/request.js"></script>
	<script src="../../js/common.js" type="text/javascript" charset="utf-8"></script>
	<script src="../../js/loading.js" type="text/javascript" charset="utf-8"></script>
	<script type="text/javascript">
		
		var newPeople = [];
		var choosePeople = [];
		var page = 1;
		var refushNum = localStorage.getItem('product_num') || 1;
		var fzrId = [];
		var resultPage = 1;
		localStorage.setItem('product_num',refushNum);
		
		show()
		function show() {
		
			var leng = $('#slider_title a');
			for(var i=0;i<leng.length;i++) {
				if($(leng[i]).html().indexOf('项目详情') != -1) {
					if(!getModuleName('CostConsultDetail')) {
						$(leng[i]).attr('href','').removeClass('mui-control-item')
						$('#item1').hide();
					}
				}
				if($(leng[i]).html().indexOf('任务分配') != -1) {
					if(!getModuleName('CostConsultTask')) {
						$(leng[i]).attr('href','').removeClass('mui-control-item')
						$('#item2').hide();
					}
				}
				if($(leng[i]).html().indexOf('进度计划') != -1) {
					if(!getModuleName('CostConsultSchedule')) {
						$(leng[i]).attr('href','').removeClass('mui-control-item')
						$('#item3').hide();
					}
				}
				if($(leng[i]).html().indexOf('成果文件') != -1) {
					if(!getModuleName('OutcomeDoc')) {
						$(leng[i]).attr('href','').removeClass('mui-control-item')
						$('#item4').hide();
					}
				}
				if($(leng[i]).html().indexOf('项目收尾') != -1) {
					if(!getModuleName('CostConsultEvaluate')) {
						$(leng[i]).attr('href','').removeClass('mui-control-item')
						$('#item5').hide();
					}
				}
			}
			for(var i=0;i<leng.length;i++) {
				if(!$(leng[i]).hasClass('mui-control-item')) {
					$(leng[i]).remove();
				}
			}
			if(!getModuleName('ManagementRWD_ZBDL')) {
				$('.task_show').hide();
			}
			if(!getModuleName('ManagementWTZL_ZBDL')) {
				$('.wtzl_show').hide();
			}
		}
		
		var height = $('.project_title_box').outerHeight();
		$('.mui-bar-nav~.mui-content .mui-slider.mui-fullscreen').css('top', height + 44 + 'px');
		
		$('#slider_title').find('a').eq(refushNum - 1).addClass('mui-active');
		$('#item'+refushNum).addClass('mui-active')
		
		//silder切换
		mui('.mui-slider').slider().stopped = true;
		mui('#slider_title').on('tap', 'a', function() {
			var num = $(this).attr('href').substr(5);
			var width = $(window).width();
			refushNum = num;
			localStorage.setItem('product_num',refushNum);
			action(width,num);
		})
		
		function action(width,num) {
			if (width < 410) {
				if (num >= 3) {
					$("#slider_title").scrollLeft(90 * (num - 3 + 1));
				} else {
					$("#slider_title").scrollLeft(0);
				}
			} else {
				if (num >= 5) {
					$("#slider_title").scrollLeft(90);
				} else {
					$("#slider_title").scrollLeft(0);
				}
			}
		}
		
		var scroll = mui('.mui-scroll-wrapper').scroll();
		mui.showLoading("正在加载..", "div");
		var projectId = common.getQueryUrl('id');
		var isfresh = false;
		document.querySelector('.mui-scroll-wrapper').addEventListener('scroll', function(e) {
			if (refushNum == 1 || refushNum == 2 || refushNum == 5) {
				return;
			}
			if(isfresh) {
				return;
			}
			if (scroll.y > 0) {
				if (scroll.y > 50) {
					isfresh = true;
					$('#pullrefresh').css('paddingTop', '84px');
					mui('.loading_btn').button('loading');
					$('.up_fress').css('zIndex', '3');
					pulldownRefresh().then(function(res) {
						if(res.code == 200) {
							pointData(res.data);
						}
						setTimeout(function() {
							$('.up_fress').css('zIndex', '2');
							$('#pullrefresh').css('paddingTop', '44px');
							mui('.loading_btn').button('reset');
							isfresh = false;
						}, 1000)
					})
				}
			}
		
			if (scroll.y != 0 && scroll.y < scroll.maxScrollY) {
				var length = $('.task_point_lists').find('.task_point_item').length;
				if (length % 5 != 0) {
					return;
				}
				isfresh = true;
				//上拉加载逻辑代码
				$('#pullrefresh').css('bottom', '40px');
				$('.down_fress').css('zIndex', '2');
				mui('.loading_btn').button('loading');
				pullupRefresh().then(function(res) {
					if(res && res.code == 200) {
						pointData(res.data,true);
					}
					setTimeout(function() {
						$('#pullrefresh').css('bottom', '0px');
						$('.down_fress').css('zIndex', '0');
						mui('.loading_btn').button('reset');
						isfresh = false;
					}, 1000)
				})
			}
		})
		
		function pulldownRefresh() {
			if (refushNum == 3) {
				return getTaskInfoList(1);
			} else if (refushNum == 4) {
				resultPage = 1;
				return getResultFile();
			}
			return common.promise();
		}
		
		function pullupRefresh() {
			if (refushNum == 3) {
				var length = $('.task_point_lists').find('.task_point_item').length;
				if (length % 5 == 0) {
					page++;
					return getTaskInfoList(page, true);
				} else {
					return common.promise();
				}
			}else if (refushNum == 4) {
				var length = $('#item4').find('.detail_info').length;
				if (length % 5 == 0) {
					resultPage++;
					return getResultFile(true);
				} else {
					return common.promise();
				}
			}
			return common.promise();
		}
		
		getProjectDetail()
		.then(function (res) {
			return getTask();
		})
		.then(function(res) {
			if(res.code == 200) {
				common.arrObjTrimAndNull(res.data)
				var contractHtml = '';
				var contractName = '';
				for(var i=0;i<res.data.Contract.lstFile.length;i++) {
					var list = res.data.Contract.lstFile[i];
					contractHtml += '<p><span class="file_name" path='+ list.FilePath +'>'+
					list.FileName + list.Extension +'</span></p>';
				}
				// if(res.data.length > 0) {
					var html = '<p>任务接收人：<span></span></p>'+
										 '<p>执行时间：<span>'+(res.data.BeginTime || '')+' 至 '+ 
										 (res.data.EndTime || '') +'</span></p>'+
										 '<p>工作内容：<span>'+ common.getNotNullData(res.data.WorkContents) +'</span></p>'+
										 '<p>工作要求：<span>'+ common.getNotNullData(res.data.WorkRequire) +'</span></p>'+
										 '<p>项目合同：<span>'+ res.data.Contract.Name +'</span></p>'+
										 '<div class="result_file_list"><div>'+
										 '<div class="class_left">合同文件：</div>'+
										 '<div class="calss_right">'+ contractHtml +'</div>'+
										 '</div></div>';
					$('#item2 .contract_info').html(html);
					$('#item2 .contract_no_data').css('display','none');
					$('#item2 .contract_info').css('display','block');
				// }
				
				var fileList = res.data.lstFile;
				var inHtml = '';
				for(var i=0;i<fileList.length;i++) {
					var filehtml = '<p><span class="file_name" path='+ fileList[i].FilePath +'>'+
					fileList[i].FileName + fileList[i].Extension +'</span></p>';
					inHtml += '<div class="detail_info" ><p class="means_title">'+ fileList[i].FileName +'</p>'+
										'<p>上传人员：<span>'+ fileList[i].CreateUser +'</span></p>'+
										'<p>上传日期：<span>'+ fileList[i].CreateTime +'</span></p>'+
										'<div class="result_file_list"><div>'+
										'<div class="class_left">文件：</div>'+
										'<div class="calss_right">'+ filehtml +'</div>'+
										'</div></div>';
				}
				if(fileList.length > 0) {
					$('#item2 .formwork_lists').html(inHtml);
					$('#item2 .formwork_no_data').css('display','none');
					$('#item2 .formwork_lists').css('display','block');
				}
				
			}
			return getSchedulePlan();
		})
		.then(function(res) {
			console.log('进度计划：',res)
			if(res.code == 200) {
				common.arrObjTrimAndNull(res.data);
				var spanHtml = ''
				for(var i=0;i<res.data.XMFZR_C.length;i++) {
					var this_list = res.data.XMFZR_C[i];
					fzrId.push(this_list.ID);
					spanHtml += '<span>'+ this_list.Name + '</span>'
				}
				if(res.data.XMFZR_C.length == 0) {
					spanHtml += '<span>无</span>';
				}
				$('.manager_names').html(spanHtml);
				
				var keyPersonnel = res.data.ZYRY_C;
				var keyHtml = '';
				for(var i=0;i<keyPersonnel.length;i++) {
					newPeople.push(keyPersonnel[i].ID)
					if(i==3) {
						keyHtml += '<span>...</span>';
					}else {
						
						if(i> 3) {
							keyHtml += '<span style="display:none;">'+ keyPersonnel[i].Name + '</span>';
						}else {
							keyHtml += '<span>'+ keyPersonnel[i].Name + '</span>';
						}
					}
				}
				if(keyPersonnel.length == 0) {
					keyHtml += '<span>无</span>';
				}
				$('.key_personnel').html(keyHtml)
			}
			return getPeople();
		})
		.then(function(res) {
			console.log('人员：',res);
			if(res.code == 200) {
				for(var i=0;i<res.data.length;i++) {
					var tem = {};
					tem.value = res.data[i].Id;
					tem.text = res.data[i].RealName;
					choosePeople.push(tem);
				}
			}
			return getTaskInfoList(1);
		})
		.then(function(res) {
			console.log('任务节点信息：',res)
			if(res.code == 200) { 
				pointData(res.data);
			}
			return getResultFile();
		})
		.then(function(res) {
			console.log('成果文件',res);
			resultData(res)
			return getShowResultFile();
		})
		.then(function(res) {
			console.log('签收显示',res);
			if(res.code == 200) {
				getShowFileData(res.data)
			}
			return getEvaluate();
		})
		.then(function(res) {
			console.log('评价显示',res);
			if(res.code == 200) {
				evaluateData(res.data);
			}
			return getProjectEvaluation();
		})
		.then(function(res) {
			console.log('项目',res)
			if(res.code == 200) {
				projectEvaluationData(res.data)
			}
			mui.hideLoading(function() {});
		}).catch(function(err) {
			console.log(err);
			mui.hideLoading(function() {});
			mui.alert('加载错误！' + err.responseText);
		})
		
		//节点数据
		function pointData(data, flag) {
			var inhtml = ''
			common.arrObjTrimAndNull(data)
			for(var i=0;i<data.length;i++) {
				var item = data[i];
				inhtml += '<div class="detail_info task_point_item" Id="'+ item.ID +'"><p>任务名称：<span>'+ item.Name +'</span></p>'+
									'<p>执行时间：<span>'+ item.StartTime +' 至 '+ item.EndTime +'</span></p>'+
									'<p>计划用时：<span>'+ item.UsingDays +'工时</span></p>'+
									'<p>参与人员：<span>'+ item.StaffName +'</span></p>'+
									'<p>分配状态：<span>'+ item.IsAcceptName +'</span></p>'+
									'<p>是否完成：<span>'+ item.IsAccomplish +'</span></p></div>'
			}
			
			if(flag) {
				$('.task_point_lists').append(inhtml);
			}else {
				$('.task_point_lists').html(inhtml);
			}
		}
		
		//获取项目详情
		function getProjectDetail() {
			var url = '/api/CostConsult/Detail';
			return request.post(url,{ProjectId: projectId}).then(function(res) {
				console.log(res)
				if(res.code == 200) {
					common.arrObjTrimAndNull(res.data)
					$('.project_name').html(res.data.Name);
					$('.project_number').html(res.data.Number);
					$('.get_money').html(res.data.ReceivableCount);
					$('.get_result_money').html(res.data.IsLast ? '是' : '否')
					var html ='<p>业务类型：<span>'+ common.getNotNullData(res.data.YWLX)  +'</span></p>'+
										'<p>合同编号：<span>'+ common.getNotNullData(res.data.ContractNumber) +'</span></p>'+
										'<p>签订日期：<span>'+ common.getNotNullData(res.data.ContractTime) +'</span></p>'+
										'<p>建设单位：<span>'+ common.getNotNullData(res.data.ConstructionUnit) +'</span></p>'+
										'<p>建设单位统一社会信用代码：<span>'+ common.getNotNullData(res.data.ConstructionUnitCode) +'</span></p>'
					$('#item1').find('.detail_info').html(html);
				}
				return res;
			})
		}
		
		//获取任务单
		function getTask() {
			var url = '/api/BusinessManage/RWDDetail';
			return request.post(url,{ProjectId: projectId}).then(function(res) {
				console.log('任务单：',res);
				return res;
			})
		}
		
		//获取进度计划（人员信息）
		function getSchedulePlan() {
			var url = '/api/CostConsult/Schedule';
			return request.post(url,{projectId: projectId}).then(function(res) {
				return res
			})
		}
		
		//获取任务节点信息列表
		function getTaskInfoList(page) {
			var url = '/api/CostConsult/ScheduleListQuery';
			var postData = {
				projectId: projectId,
				StaffName: '',
				Page: page,
				Limit: 5
			}
			return request.post(url,postData).then(function(res) {
				return res;
			})
		}
		
		//保存进度计划人员
		function savePeople() {
			var url = '/api/CostConsult/SaveScheduleStaff';
			var postData = {
				projectId: projectId,
				xmfzrs: fzrId.join(','),
				zyrys: newPeople.join(','),
				isSubmit: false
			}
			return request.post(url,postData).then(function(res) {
				console.log(res);
				if(res.code == 200) {
					mui.toast('添加成功');
				}
			})
		}
		
		//获取成果文件
		function getResultFile(flag) {
			var url = '/api/CostConsult/OutcomeDocQuery';
			var postData = {
				projectId: projectId,
				page: resultPage,
				limit: 5
			}
			return request.post(url,postData).then(function(res) {
				if(res.flag) {
					res.flag = flag;
				}
				return res;
			})
		}
		
		//成果文件列表数据
		function resultData(res) {
			if(res.code == 200) {
				common.arrObjTrimAndNull(res.data)
				var html = '';
				for(var i=0;i<res.data.length;i++) {
					var data = res.data[i];
					var filename = '';
					for(var j=0;j<data.lstFile.length;j++) {
						filename += '<p><span class="file_name" path='+ data.lstFile[j].FilePath +'>'+ 
						data.lstFile[j].Name + data.lstFile[j].FileFormat +'</span></p>';
					}
					var stateStr = '';
					if(data.State == -1) {
						stateStr = '已拒绝';
					}else if(data.State == 0){
						stateStr = '未审核';
					}else if(data.State == 1){
						stateStr = '审核中';
					}else if(data.State == 2){
						stateStr = '审核通过';
					}
					html += '<div class="detail_info detail_info_result" listid='+ data.Id +' state='+ data.State +'>'+
									'<p>文件名称：<span>'+ data.Name +'</span></p>'+
									'<p>文件类型：<span>'+ data.FileType +'</span></p>'+
									'<p>编制日期：<span>'+ data.MakeDate +'</span></p>'+
									'<div class="result_file_list"><div>'+
									'<div class="class_left">成果文件：</div>'+
									'<div class="calss_right">'+ filename +'</div>'+
									'</div></div>'+
									'<p>上传人员：<span>'+ data.UserName +'</span></p>'+
									'<p>审批状态：<span>'+ data.StateName +'</span></p></div>';
				}
				if(res.data.length == 0) {
					html = '<div class="detail_info detail_info_no_data bid_no_data">'+
					'<img src="../../img/no_data.png" ><p>未有数据</p></div>';
				}
				if(res.flag) {
					$('.result_list_info').append(html);
				}else {
					$('.result_list_info').html(html);
				}
				
			}
		}
		
		//项目收尾-成果文件签收显示
		function getShowResultFile() {
			var url = '/api/CostConsult/OutcomeSignQuery';
			var postData = {
				projectId: projectId,
				page: 1,
				Limit: 500
			}
			return request.post(url,postData).then(function(res) {
				return res;
			})
		}
		function getShowFileData(data) {
			var html = '';
			common.arrObjTrimAndNull(data)
			for(var i=0;i<data.length;i++) {
				html+= '<div class="detail_info" itemsid='+ data[i].ID +'>'+
							 '<p>签收日期：<span>'+ data[i].SignTime +'</span></p>'+
							 '<p>签收单：<span class="file_name" path='+ data[i].FilePath +'>'+ data[i].FileName +'</span></p>'+
							 '<p>备注：<span>'+ data[i].Remarks +'</span></p>'+
							 '<p class="btn_class"><span class="delete_btn delete_sign_file">删除</span>'+
							 '<span class="update_btn update_sign_file">修改</span></p></div>';
			}
			
			if(data.length > 0) {
				$('.show_files').html(html);
			}else {
				html = '<div class="detail_info detail_info_no_data bid_no_data">'+
				'<img src="../../img/no_data.png" ><p>未有数据</p></div>';
				$('.show_files').html(html);
			}
		}
		
		//获取业主评价展示
		function getEvaluate() {
			var url = '/api/CostConsult/OwnerEvaluate';
			var postData = {
				projectId: projectId,
				page: 1,
				Limit: 500
			}
			return request.post(url,postData);
		}
		function evaluateData(data) {
			common.arrObjTrimAndNull(data)
			var html = '';
			for(var i=0;i<data.length;i++) {
				html += '<div class="detail_info" evaluateid='+ data[i].ID +' >'+
								'<p>征询发起人：<span>'+ common.getNotNullData(data[i].RealName) +'</span></p>'+
								'<p>发起时间：<span>'+ data[i].InitiatorDate +'</span></p>'+
								'<p>征询反馈人：<span>'+ common.getNotNullData(data[i].FeadbackUser) +'</span></p>'+
								'<p>反馈人电话：<span>'+ common.getNotNullData(data[i].FeadbackPhone) +'</span></p>'+
								'<p>反馈时间：<span>'+ data[i].FeadbackDate +'</span></p>'+
								'<p class="btn_class"><span class="delete_btn delete_eva">删除</span>'+
								'<span class="update_btn check_eva">查看客户评价</span></p></div>';
			}
			if(data.length> 0) {
				$('.evaluate').html(html);
			}else {
				html = '<div class="detail_info detail_info_no_data bid_no_data">'+
				'<img src="../../img/no_data.png" ><p>未有数据</p></div>';
				$('.evaluate').html(html);
			}
		}
		
		//项目部人员评价显示
		function getProjectEvaluation() {
			var url = '/api/CostConsult/DepartmentStaffEvaluate';
			var postData = {
				projectId: projectId,
				page: 1,
				Limit: 500
			}
			return request.post(url,postData);
		}
		
		function projectEvaluationData(res) {
			var html = '';
			common.arrObjTrimAndNull(data)
			for(var i=0;i<res.length;i++) {
				var data = res[i];
				html += '<div class="detail_info" id='+ data.ID +' userid='+ data.Id + '>'+
								'<p>姓名：<span>'+ data.RealName +'</span></p>'+
								'<p>职务：<span>'+ data.RelationType +'</span></p>'+
								'<p>评价：<span>'+ data.Result +'</span></p>'+
								'<p>评价人：<span>'+ data.WriteUser +'</span></p>'+
								'<p>评价时间：<span>'+ data.CreatedTime +'</span></p>'+
								'<p class="btn_class"><span class="update_btn">评价</span></p></div>';
			}
			if(res.length> 0) {
				$('.evaluate_list').html(html);
			}else {
				html = '<div class="detail_info detail_info_no_data bid_no_data">'+
				'<img src="../../img/no_data.png" ><p>未有数据</p></div>';
				$('.evaluate_list').html(html);
			}
		}
		
		(function(mui) {
			//联系人选择
			mui.ready(function() {
				var _getParam = function(obj, param) {
					return obj[param] || '';
				};
				var userPicker = new mui.PopPicker();

				var showUserPickerButton = mui('.member_add');
				showUserPickerButton.each(function(i, btn) {
					btn.addEventListener('tap', function(event) {
						var isCreate = true;
						if(getModuleName('CostConsultSchedule')) {
							if(operationArr.length > 0) {
								for(var i=0;i<operationArr.length;i++) {
									if(operationArr[i].KeyCode == 'Update') {
										if(!operationArr[i].IsValid) {
											isCreate = false;
										}
									}
								}
							}
						}
						// if(isCreate) {
						// 	userPicker.setData(choosePeople);
						// 	userPicker.show(function(items) {
								
						// 		if(newPeople.indexOf(items[0].value) != -1) {
						// 			mui.toast('已存在');
						// 			return;
						// 		}
						// 		var length = $('.key_personnel').find('span').length;
						// 		if(length == 3) {
						// 			$('.key_personnel').append('<span>...</span>')
						// 		}else if(length < 3){
						// 			$('.key_personnel').append('<span>'+ items[0].text +'</span>')
						// 		}
						// 		newPeople.push(items[0].value);
						// 		savePeople();
						// 	});
						// }else {
						// 	mui.toast('没有权限！');
						// }
						
					}, false);
				});
			});	
		})(mui);
		
		//预览任务单文件
		mui('#item2').on('tap','.file_name',function() {
			var path = $(this).attr('path');
			console.log(path)
			mui.showLoading('加载中...')
			openFile(baseUrl + path);
		})
		
		//点击添加任务节点
		mui('.project_task_point').on('tap','.add_task_point',function() {
			var isCreate = true;
			if(getModuleName('CostConsultSchedule')) {
				if(operationArr.length > 0) {
					for(var i=0;i<operationArr.length;i++) {
						if(operationArr[i].KeyCode == 'Create') {
							if(!operationArr[i].IsValid) {
								isCreate = false;
							}
						}
					}
				}
			}
			if(isCreate) {
				window.location.href = './add_task_point.html?projectId='+projectId+'&projectName=' + $('.project_name').html();
			}else {
				mui.toast('没有权限！');
			}
		})
		
		//任务节点进度计划
		mui('.project_task_point').on('tap','.task_point_item',function() {
			if($('#middlePopover').css('display') == 'block') {
				$('#middlePopover').hide();
				return;
			}
			var isCreate = true;
			if(getModuleName('CostConsultSchedule')) {
				if(operationArr.length > 0) {
					for(var i=0;i<operationArr.length;i++) {
						if(operationArr[i].KeyCode == 'Update') {
							if(!operationArr[i].IsValid) {
								isCreate = false;
							}
						}
					}
				}
			}
			if(isCreate) {
				window.location.href = './plan.html?projectId='+projectId+'&projectName=' + $('.project_name').html() + '&id='+ $(this).attr('Id');
			}else {
				mui.toast('没有权限！');
			}
		})
		
		//长按删除
		mui('#item3').on('longtap', '.task_point_item', function(e) {
			$('#item3').find('#middlePopover').remove();
			$(this).append(
				'<div id="middlePopover" class="mui-popover"><button type="button" class="mui-btn mui-btn-blue mui-btn-outlined delete_record">删除</button><span></span></div>'
			);
			$('#middlePopover').show()
		})
		
		mui('html').on('tap', 'body', function() {
			$('#middlePopover').hide()
		})
		//删除进度计划
		mui('#item3').on('tap', '.delete_record', function(e) {
			e.stopPropagation();
			var isCreate = true;
			if(getModuleName('CostConsultSchedule')) {
				if(operationArr.length > 0) {
					for(var i=0;i<operationArr.length;i++) {
						if(operationArr[i].KeyCode == 'Delete') {
							if(!operationArr[i].IsValid) {
								isCreate = false;
							}
						}
					}
				}
			}
			if(!isCreate) {
				mui.toast('没有权限！');
				return;
			}
			var id = $(this).parents('.task_point_item').attr('Id');
			var deleteUrl = '/api/CostConsult/DeleteSchedule';
			var postdta = {
				Ids: [id]
			}
			var _this = this;
			request.post(deleteUrl, postdta).then(function(res) {
				console.log(res)
				if (res.code == 200) {
					mui.toast('删除成功！');
					$(_this).parents('.task_point_item').remove();
				} else {
					mui.toast('删除失败！')
				}
			})
		})
		
		//添加成果文件
		mui('#item4').on('tap','.add_point',function() {
			var isCreate = true;
			if(getModuleName('OutcomeDoc')) {
				if(operationArr.length > 0) {
					for(var i=0;i<operationArr.length;i++) {
						if(operationArr[i].KeyCode == 'Create') {
							if(!operationArr[i].IsValid) {
								isCreate = false;
							}
						}
					}
				}
			}
			if(isCreate) {
				window.location.href = 'add_chengguowenjian.html?projectId='+projectId+'&projectName=' + $('.project_name').html();
			}else {
				mui.toast('没有权限！');
			}
			
		})
		
		//查看详情或修改
		mui('.result_list_info').on('tap','.detail_info_result',function(e) {
			var this_id = $(this).attr('listid');
			if($('#middlePopover').css('display') == 'block') {
				$('#middlePopover').hide();
				return;
			}
			if($(e.target).hasClass('file_name')) {
				return;
			}
			var isCreate = true;
			if(getModuleName('OutcomeDoc')) {
				if(operationArr.length > 0) {
					for(var i=0;i<operationArr.length;i++) {
						if(operationArr[i].KeyCode == 'Update') {
							if(!operationArr[i].IsValid) {
								isCreate = false;
							}
						}
					}
				}
			}
			if(isCreate) {
				window.location.href = 'add_chengguowenjian.html?projectId='+
				projectId+'&projectName=' + $('.project_name').html() + '&id=' + this_id;
			}else {
				window.location.href = 'add_chengguowenjian.html?projectId='+
				projectId+'&projectName=' + $('.project_name').html() + '&id=' + this_id + '&check=true';
			}
			
		})
		
		//预览成果文件
		mui('.result_list_info').on('tap','.file_name',function() {
			var path = $(this).attr('path');
			console.log(path)
			mui.showLoading('加载中...')
			openFile(baseUrl + path);
		})
		
		//长按删除
		mui('#item4').on('longtap', '.detail_info_result', function(e) {
			$('#item4').find('#middlePopover').remove();
			$(this).append(
				'<div id="middlePopover" class="mui-popover"><button type="button" class="mui-btn mui-btn-blue mui-btn-outlined delete_record">删除</button><span></span></div>'
			);
			$('#middlePopover').show()
		})
		
		//删除成果文件
		mui('#item4').on('tap', '.delete_record', function(e) {
			e.stopPropagation();
			var isCreate = true;
			if(getModuleName('OutcomeDoc')) {
				if(operationArr.length > 0) {
					for(var i=0;i<operationArr.length;i++) {
						if(operationArr[i].KeyCode == 'Delete') {
							if(!operationArr[i].IsValid) {
								isCreate = false;
							}
						}
					}
				}
			}
			if(!isCreate) {
				mui.toast('没有权限！');
				return;
			}
			var id = $(this).parents('.detail_info_result').attr('listid');
			var state = $(this).parents('.detail_info_result').attr('state');
			if(state != 0) {
				mui.toast('已提交的信息没有删除权限！');
				return;
			}
			var deleteUrl = '/api/CostConsult/DeleteOutcomeDoc';
			var postData = {
				Ids: [id]
			}
			console.log(postData)
			var _this = this;
			request.post(deleteUrl, postData).then(function(res) {
				console.log(res)
				if (res.code == 200) {
					mui.toast('删除成功！');
					$(_this).parents('.detail_info_result').remove();
				} else {
					mui.toast('删除失败！')
				}
			})
		})
		
		//成果文件签收
		mui('#item5').on('tap','.add_file_sign',function() {
			var isCreate = true;
			if(getModuleName('CostConsultEvaluate')) {
				if(operationArr.length > 0) {
					for(var i=0;i<operationArr.length;i++) {
						if(operationArr[i].KeyCode == 'Create') {
							if(!operationArr[i].IsValid) {
								isCreate = false;
							}
						}
					}
				}
			}
			if(isCreate) {
				window.location.href = 'add_sign_file.html?projectId='+
				projectId+'&projectName=' + $('.project_name').html();
			}else {
				mui.toast('没有权限！');
			}
			
		})
		
		//预览成果文件签收单
		mui('.show_files').on('tap','.file_name',function() {
			var path = $(this).attr('path');
			mui.showLoading('加载中...')
			openFile(baseUrl + path)
		})
		
		//修改成果文件签收
		mui('#item5').on('tap','.update_sign_file',function() {
			var id = $(this).parents('.detail_info').attr('itemsid')
			var isCreate = true;
			if(getModuleName('CostConsultEvaluate')) {
				if(operationArr.length > 0) {
					for(var i=0;i<operationArr.length;i++) {
						if(operationArr[i].KeyCode == 'Update') {
							if(!operationArr[i].IsValid) {
								isCreate = false;
							}
						}
					}
				}
			}
			if(isCreate) {
				window.location.href = 'add_sign_file.html?projectId='+
				projectId+'&projectName=' + $('.project_name').html() + '&id=' + id;
			}else {
				mui.toast('没有权限！');
			}
			
		})
		
		//删除成果文件签收
		mui('#item5').on('tap','.delete_sign_file',function() {
			var id = $(this).parents('.detail_info').attr('itemsid')
			var url = '/api/CostConsult/DeleteOutcomeSign';
			var isCreate = true;
			if(getModuleName('CostConsultEvaluate')) {
				if(operationArr.length > 0) {
					for(var i=0;i<operationArr.length;i++) {
						if(operationArr[i].KeyCode == 'Delete') {
							if(!operationArr[i].IsValid) {
								isCreate = false;
							}
						}
					}
				}
			}
			if(!isCreate) {
				mui.toast('没有权限！');
				return;
			}
			var _this = this;
			request.post(url,{Ids: id}).then(function(res) {
				if(res.code == 200) {
					mui.toast('删除成功');
					$(_this).parents('.detail_info').remove();
					if($('.show_files').find('.detail_info').length == 0) {
						var html = '<div class="detail_info detail_info_no_data bid_no_data">'+
						'<img src="../../img/no_data.png" ><p>未有数据</p></div>';
						$('.show_files').html(html);
					}
				}else {
					mui.toast('删除失败');
				}
			})
		})
		
		//业主评价 
		mui('#item5').on('tap','.add_Owner_eva',function() {

				window.location.href = 'consultation.html?projectId='+
				projectId+'&projectName=' + $('.project_name').html();
		
			
		})
		
		//查看业主评价
		mui('#item5').on('tap','.check_eva',function() {
			var id = $(this).parents('.detail_info').attr('evaluateid');
			window.location.href = './check_eva.html?id=' + id;
		})
		
		//删除业主评价
		mui('#item5').on('tap','.delete_eva',function() {
			var id = $(this).parents('.detail_info').attr('evaluateid');
			var url = '/api/CostConsult/DeleteOwnerEvaluate';
			var _this = this;
			var isCreate = true;
			if(getModuleName('CostConsultEvaluate')) {
				if(operationArr.length > 0) {
					for(var i=0;i<operationArr.length;i++) {
						if(operationArr[i].KeyCode == 'Delete') {
							if(!operationArr[i].IsValid) {
								isCreate = false;
							}
						}
					}
				}
			}
			if(!isCreate) {
				mui.toast('没有权限！');
				return;
			}
			request.post(url,{Ids: id}).then(function(res) {
				if(res.code == 200) {
					mui.toast('删除成功');
					$(_this).parents('.detail_info').remove();
					if($('.evaluate').find('.detail_info').length == 0) {
						var html = '<div class="detail_info detail_info_no_data bid_no_data">'+
						'<img src="../../img/no_data.png" ><p>未有数据</p></div>';
						$('.evaluate').html(html);
					}
				}else {
					mui.toast('删除失败');
				}
			})
		})
		
		
		//评价
		mui('.evaluate_list').on('tap','.update_btn',function() {
			var name = $(this).parents('.detail_info').find('p').eq(0).find('span').html();
			var post = $(this).parents('.detail_info').find('p').eq(1).find('span').html();
			var userId = $(this).parents('.detail_info').attr('userid');
			
		
				window.location.href = 'evaluate.html?projectId='+
				projectId+'&projectName=' + $('.project_name').html() + '&id=' + userId
				 + '&name='+ name + '&post=' + post;
		})
		
		
		mui('#item3').on('tap', '.member_add', function() {

			$(".meau_list").animate({right:0});
			console.log(choosePeople)
			var html2 = '';
			for(var i=0;i<choosePeople.length;i++) {
				var item = choosePeople[i];
				html2 += '<span id='+ item.value +' class="spans">'+ item.text +'</span>'
			}
			$('.ele_meal').html(html2);
			slideDetail(newPeople);
			// newPhyId = newPhyId.concat(physicsSealId);
			// newPhyname = newPhyname.concat(phyName);
		});
		
		function slideDetail(idArr) {
			var list = $('.list_table span');
			for(var i=0;i<idArr.length;i++) {
				for(var j=0;j<list.length;j++) {
					if(idArr[i] == $(list[j]).attr('Id')) {
						$(list[j]).addClass('active');
					}
				}
			}
		}
		
		
			mui('.list_table').on('tap', 'span', function() {
				var this_id = $(this).attr('id');
				var this_name = $(this).html();
					if($(this).hasClass('active')) {
						$(this).removeClass('active');
						newPeople.splice(newPeople.indexOf(this_id),1); 
					}else {
						$(this).addClass('active');
						newPeople.push(this_id);
					}
			});
		
		
		var btn = document.getElementById("meau_box");
		btn.addEventListener('tap',function(e) {
			if($(e.target).hasClass('spans')) {
				return
			}
			$(".meau_list").animate({right:'-100%'});
		})
		mui('.btn_box_meau').on('tap', 'button', function() {
			$(".meau_list").animate({right:'-100%'});
			if(!$(this).hasClass('meau_cancel')) {
				savePeople();
				var keyHtml = '';
				for(var i=0;i<newPeople.length;i++) {
					if(i==3) {
						keyHtml += '<span>...</span>';
					}else {
						
						if(i> 3) {
							keyHtml += '<span style="display:none;">'+ common.getKeyValue(choosePeople,newPeople[i]) + '</span>';
						}else {
							keyHtml += '<span>'+ common.getKeyValue(choosePeople,newPeople[i]) + '</span>';
						}
					}
				}
				$('.key_personnel').html(keyHtml)
			}
		});
		
		
	</script>

</html>
