<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>库存调拨</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../../css/mui.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="../../../css/comon.css" />
		<script src="../../../js/mui.js"></script>
		<link rel="stylesheet" type="text/css" href="../../../css/Finance.css" />
		<script src="../../../js/polyfill.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript" src="../../../js/jquery.min.js"></script>
		<link rel="stylesheet" type="text/css" href="../../../css/menu.css"/>
		<link rel="stylesheet" type="text/css" href="../../../css/leave.css"/>
		<link rel="stylesheet" type="text/css" href="../../../css/mui.picker.min.css"/>
		<style type="text/css">
			.footer_btn{
				width: 80%;
			}
		 
			.meau_list{
				top: 44px;
				height: calc(100% - 44px);
			}
			.mui-backdrop{
				z-index: 999;
			}
		
			.offcas {
				height: 80%;
				overflow: hidden;
			}
			.mui-nav-more_nr {
				width: 130px;
			}
			.revene_all li {
				padding: 10px 20px 20px;
				border-radius: 10px;
			}
			.list_top {
				color: #000000;
				height: 40px;
				line-height: 40px;
				font-weight: bold;
			}
			.list_top span {
				font-size: 14px;
				padding: 0px 10px;
				border-radius: 16px;
				color: white;
				margin-left: 10px;
			}
			.list_top span.green {
				background: #46CC8E;
			}
			.list_top span.orange {
				background: #FE9B26;
			}
			.list_top span.red {
				background: #FF6060;
			}
			.list_detail p {
				margin: 0;
				color: #333333;
			}
			
			.list_detail p span {
				color: #999999;
			}
			.list_detail div{
				display: grid;
				grid-template-columns: 1fr 1fr;
			}
			.list_detail div p{
				padding-left: 5px;
				white-space: nowrap;
				border-left: 4px solid #0062CC;
			}
			
			#pullrefresh {
				top: 40px;
			}
			
			.count_box {
				height: 40px;
				line-height: 40px;
				background: white;
				margin-top: 10px;
				padding: 0px 20px;
				position: relative;
				
			}
			
			.count_box p {
				color: #000000;
				margin: 0;
			}
			
			.filter_list {
				height: 20px;
				line-height: 20px;
				padding: 0px 5px;
				border: solid 1px #3B9CFF;
				color: #3B9CFF;
				border-radius: 16px;
				position: absolute;
				right: 20px;
				top: 10px;
			}
			
			.meau_list .list_table {
				padding: 0px 20px;
			}
			.mean_top {
				height: 44px;
				line-height: 44px;
			}
			.meau_list .list_table .items {
				padding: 0px 0px 15px;
			}
			.meau_list .list_table p {
				padding-left: 0;
			}
			.meau_list .list_table .items span {
				width: 30%;
				margin-right: 3%;
				font-size: 0.675rem;
				padding: 0;
			}
			#middlePopover button{
				margin-top: 10%;
			}
			
		</style>
	</head>

	<body class="this_body">
		<header class="mui-bar mui-bar-nav header_box">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">库存调拨</h1>
			<!-- <img src="../../../img/add.png" class="mui-nav-more"> -->
			<span class="mui-nav-more" style="font-weight:normal;line-height: 44px;">
				更多
			</span>
		</header>
		<div class="mui-nav-more_nr_t">
			<div class="mui-nav-more_nr" style="height: 70px;">
				<!-- <img class="add_invoice" src="../../../img/fixed_asse.png"> -->
				<span>新增库存调拨</span>
				<br >
				<!-- <span>筛选</span> -->
				 <span class="filter_list">筛选</span>
			</div>
		</div>
		<div class="mui-content">
			<div class="message_title" style="display: none;">
				<div class="search_box">
					<div class="mui-input-row mui-search">
						<input id="search_input" type="text" class="" placeholder="搜索仓库名称/责任人员">
						<span class="photo_search" index='item1'></span>
					</div>
				</div>
			</div>
			<!--  -->
		<!-- 	<div id="slider" class="mui-slider">
			    <div class="mui-scroll-wrapper mui-slider-indicator mui-segmented-control mui-segmented-control-inverted" id="segmented">
							<div class="mui-scroll">
								
	
							</div>
					</div>
			
							
			</div> -->
			<!--  -->
			<div class="count_box" style="display: none;">
				<p>产品数量：<span class="count">100</span> <span class="filter_list">筛选</span></p>
			</div>
		
			<div id="pullrefresh" class="mui-scroll-wrapper projuct_manager">
				<p class="up_fress data-loading-icon">
					<button type="button" data-loading-icon="mui-spinner mui-spinner-custom" data-loading-text="刷新中" class="loading_btn"></button>
				</p>
				<div class="mui-scroll">
					<div class="message_content">
						<ul class="revene_all">
							<!-- <li>
								<div class="list_top">资产编号 JKY-123 <span class="green">正常</span></div>
								<div class="list_detail">
								 
									<p>产品名称：<span>电脑</span></p>
									<p>所属仓库：<span>电脑</span></p>
									<p>备注：<span>电脑</span></p>
									<div>
										<p>入库数量：<span>200</span></p>
										<p>入库日期：<span>2020/03/02</span></p>
									</div>
								</div>
							</li> -->
						</ul>
					</div>
				</div>
			</div>
			<p class="down_fress data-loading-icon">
				<button type="button" data-loading-icon="mui-spinner mui-spinner-custom" data-loading-text="加载中" class="loading_btn"></button>
			</p>
			
		</div>
		<div class="meau_list" style="display: block;">
			
			<div class="list_table spans">
				<div class="mean_top spans">
					筛选
				</div>
				<p class="spans">产品名称</p>
				<p class="choose_project"><a>请选择</a><span></span></p>
				<p class="spans">调入仓库</p>
				<p class="choose_project"><a>请选择</a><span></span></p>
				<p class="spans">所属仓库</p>
				<p class="choose_project"><a>请选择</a><span></span></p>
				<p>调拨日期</p>
				<div class="plan_time">
			<!-- 		<input class="choose_time start_times plan_timess" placeholder="开始时间"> — <input class="choose_time end_times plan_timess" placeholder="结束时间"> -->
			<span class="choose_time start_times plan_timess">开始时间</span> — <span class="choose_time end_times plan_timess">结束时间</span>
				</div>
			<!-- 	<p class="spans">资产来源</p>
				<div class="asset_source items spans">
					
				</div> -->
		 
				
			</div>
			<div class="footer_btn spans">
				<span class="btn_reset spans">重置</span><span class="btn_submit spans">确定</span>
			</div>
		</div>
	</body>
</html>
<script src="../../../js/mui.picker.min.js" type="text/javascript" charset="utf-8"></script>
<script src="../../../js/common.js" type="text/javascript" charset="utf-8"></script>
<script src="../../../js/request.js" type="text/javascript" charset="utf-8"></script>
<script src="../../../js/loading.js" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript">
	var page = 1;
	var searchText = '';
	var type,source,state;
	var isfirst = true;
	var startTimes = '',endTimes = '';
	var input = $("input");
	var ProductArr = {name:[1,2.3,2],id:''};//产品名称
	var storageArr = {name:[2,3,4],id:''};//所属仓库
	var storageArr1 = {name:[5,6,7],id:''};//调入仓库
	//allotList
	var allotListUrl = '/api/Resource/StorageAllotQuery';
	//获取列表
	mui.init({
		gestureConfig: {
			tap: true, //默认为true
			doubletap: true, //默认为false
			longtap: true, //默认为false
			swipe: true, //默认为true
			drag: true, //默认为true
			hold: true, //默认为false，不监听
			release: false //默认为false，不监听
		},
	});
	var scroll = mui('.mui-scroll-wrapper').scroll({
		bounce: true,
		indicators: false, //是否显示滚动条
		deceleration: mui.os.ios?0.003:0.0009
	});
	var isfresh = false;
	
	var isCreate = true,isUpdate = true, isDelete = true;
	if(getModuleName('AssetsManage')) {
		if(operationArr.length > 0) {
			for(var i=0;i<operationArr.length;i++) {
				if(operationArr[i].KeyCode == 'Create') {
					if(!operationArr[i].IsValid) {
						isCreate = false;
					}
				}
				if(operationArr[i].KeyCode == 'Update') {
					if(!operationArr[i].IsValid) {
						isUpdate = false;
					}
				}
				if(operationArr[i].KeyCode == 'Delete') {
					if(!operationArr[i].IsValid) {
						isDelete = false;
					}
				}
			}
		}
	}
	
	document.querySelector('.mui-scroll-wrapper').addEventListener('scroll', function(e) {
		if(isfresh) {
			return;
		}
		if (scroll.y > 0) {
			if (scroll.y > 50) {
				isfresh = true;
				$('#pullrefresh').css('paddingTop', '40px');
				mui('.loading_btn').button('loading');
				$('.up_fress').css('opacity', '1');
				$('#search_input').val('');
				page = 1;
				getList(true,searchText,type,source,state).then(function() {
					setTimeout(function() {
						$('.up_fress').css('opacity', '0');
						$('#pullrefresh').css('paddingTop', '0px');
						mui('.loading_btn').button('reset');
						mui('.mui-scroll-wrapper').scroll().scrollTo(0,0,100);
						isfresh = false;
					}, 1000)
				})
			}
		}
		if (scroll.y != 0 && Math.abs(scroll.maxScrollY) - Math.abs(scroll.y) < -50) {
			var liLength = $('.revene_all li').length;
			if (liLength % 10 != 0) {
				return;
			}
			isfresh = true;
			//上拉加载逻辑代码
			$('#pullrefresh').css('bottom', '40px');
			$('.down_fress').css('zIndex', '2');
			mui('.loading_btn').button('loading');
			page = parseInt( liLength / 10) + 1;
			getList(false,searchText,type,source,state).then(function(res) {
				setTimeout(function() {
					$('#pullrefresh').css('bottom', '0px');
					$('.down_fress').css('zIndex', '0');
					mui('.loading_btn').button('reset');
					isfresh = false;
				}, 1000)
			});
		}
	})
	mui.showLoading('正在加载中...');
	common.promise()
	// .then(function() {
		
	// })
	.then(getList(true))
	.then(function() {
		return getType();
	})
	.then(function() {
		return getSource();
	})
	.then(function() {
		mui.hideLoading();
	})
	
	function getList(flag,storeName,name,source,state) {
		var url = allotListUrl;
		var postData = {
			page: page,
			limit: 10,
			ProductName: '',
			ProductType:''
		}
		console.log(postData)
		return request.post(allotListUrl,postData).then(function(res) {
			console.log(res);
			
			if(res.code == 200) {
				$('.count').html(res.count);
				var html = '';
				for(var i=0;i<res.data.length;i++) {
					var data = res.data[i];
					 
					var operation = '';
					 
					html += '<li id='+ data.ID +'>'+
									// '<div class="list_top">资产编号 '+ common.getNotNullData(data.No)  +
									//  +'</div>'+
									'<div class="list_detail">'+
								 
									'<p>产品名称：<span>'+ common.getNotNullData(data.ProductName)  +'</span></p>'+
									'<p>所属仓库：<span class="name">'+ common.getNotNullData(data.StorageName)  +'</span></p>'+
									'<p>调入仓库：<span class="name">'+ common.getNotNullData(data.ByStorageName)  +'</span></p>'+
									'<p>备注：<span>'+ common.getNotNullData(data.Remark)  +'</span></p>'+
								  ' <div class="allot_info"> <p>入库数量：<span>'+data.StorageSum+'</span></p><p>入库日期：<span>'+data.CreateTime+'</span></p> </div>' +
									'</div></li>';
				}
				if(res.data.length == 0 && page == 1) {
					html = '<div class="detail_info detail_info_no_data bid_no_data">'+
					'<img src="../../../img/no_data.png" ><p>还未有数据！</p></div>';
				}
				
				if(flag) {
					$('.revene_all').html(html)
				}else {
					if(res.data.length > 0) {
						$('.revene_all').append(html)
					}
				}
				return;
			}
		})
	}
	
	$('#search_input').on('change',function() {
		searchText = $(this).val();
		page = 1;
		getList(true,searchText)
	})
	
	//获取资产类别
	function getType() {
		var url = '/api/Resource/CategorySelect';
		return request.post(url).then(function(res) {
			console.log('类别:',res);
			if(res.code == 200) {
				var html = '';
				for(var i=0;i<res.data.length;i++) {
					html += '<span class="spans" this_id='+ res.data[i].Value +'>'+ res.data[i].Text +'</span>'
				}
				$('.asset_type').html(html)
			}
		})
	}
	//获取资产来源
	function getSource() {
		var url = '/api/Resource/SourceSelect';
		return request.post(url).then(function(res) {
			console.log('来源:',res);
			if(res.code == 200) {
				var html = '';
				for(var i=0;i<res.data.length;i++) {
					html += '<span class="spans" this_id='+ res.data[i].Value +'>'+ res.data[i].Text +'</span>'
				}
				$('.asset_source').html(html)
			}
		})
	}
	
 
	
	
	//删除
	// mui('#pullrefresh').on('tap','.delete_this_btn',function() {
	// 	if(!isDelete) {
	// 		mui.toast('没有权限！');
	// 		return;
	// 	}
	// 	var thisId = $(this).parents('li').attr('id');
	// 	deleteLi(thisId,this);
	// })
	
	// function deleteLi(Id,self) {
	// 	var url = '/api/ContractManage /DelStorageManage';
	// 	request.post(url,{Ids: Id}).then(function(res) {
	// 		if(res.code == 200) {
	// 			$(self).parents('li').remove();
	// 			$('.count').html($('.count').html() - 1);
	// 			mui.toast('删除成功！')
	// 		}
	// 	})
	// }
	
	//点击详情
	mui('.message_content').on('tap','li',function(e) {
		if($(e.target).hasClass('mui-popover')) {
			$('#middlePopover').hide();
			return;
		}
		if($(e.target).hasClass('mui-btn')) {
			$('#middlePopover').hide();
			return;
		}
		if($(e.target).hasClass('revene_all_btn_tj') || 
		$(e.target).hasClass('revene_all_btn_sc') || 
		$(e.target).hasClass('record_info') || 
		$(e.target).hasClass('examine_in') || 
		$(e.target).hasClass('update_in_info') || 
		$(e.target).hasClass('submit_again')) {
			return;
		}
		var thisId = $(this).attr('id');
		var thisName = $(this).find('.name')[0].innerText;
		if(isUpdate) {
			window.location.href = './new.html?id=' + thisId + '&check=true' + '&name='+ thisName;
		}else {
			window.location.href = './new.html?id=' + thisId + '&onlysee=true';
		}
	})
	
	//添加
	mui('.mui-nav-more_nr_t').on('tap','.mui-nav-more_nr span',function(e) {
		if (e.target.className != '') {
			
			 $(".meau_list").animate({right:0});
		}else {
			
			if(isCreate) {
				window.location.href = './new.html';
			}else {
				mui.toast('没有权限！');
			}
		}
	})
	//点击头部更多
	mui('.header_box').on('tap','.mui-nav-more',function() {
		$('.mui-nav-more_nr_t').show();
	})
	
	mui('.mui-nav-more_nr_t')[0].addEventListener('tap',function() {
		$('.mui-nav-more_nr_t').hide();
	})
	
	mui('.count_box').on('tap','.filter_list',function() {
		$(".meau_list").animate({right:0});
	})
	
	mui('.this_body').on('tap','.meau_list',function(e) {
		if($(e.target).hasClass('spans')) return;
		$(".meau_list").animate({right:'-100%'});
	})
	
	mui('.list_table').on('tap','span',function() {
		$(this).addClass('active');
		$(this).siblings().removeClass('active');
	})
	mui('.footer_btn').on('tap','.btn_reset',function() {
		$('.list_table').find('.active').removeClass('active');
		page = 1;
		type = null;source = null;state = null;
		startTimes = '';endTimes = '';
		getList(true,null,type,source,state);
		// $(".meau_list").animate({right:'-100%'});
		 mui('.mui-scroll-wrapper').scroll().scrollTo(0, 0, 500);
	})
	mui('.footer_btn').on('tap','.btn_submit',function() {
		if($('.asset_type').find('.active').length > 0) {
			type = $('.asset_type').find('.active').attr('this_id');
		}
		if($('.asset_source').find('.active').length > 0) {
			source = $('.asset_source').find('.active').attr('this_id');
		}
		state = '';
		page = 1;
		console.log(type,source,state);
		getList(true,null,type,source,state);
		$(".meau_list").animate({right:'-100%'});
	})
	
	mui('.list_table').on('tap','.choose_time',function(e) {
		e.stopPropagation();
	});
	
	// 一级选择器 产品名称 所属仓库 调入仓库
 
		mui.ready(function() {
			var _getParam = function(obj, param) {
				return obj[param] || '';
			};
			var userPicker = new mui.PopPicker();
			var showUserPickerButton = mui('.choose_store');
			showUserPickerButton.each(function(i, btn) {
				btn.addEventListener('tap', function(event) {
					// $('.choose_store').blur();
					// $('textarea').blur()
		 
					var _this = this;
					console.log(123,$(this))
					if ($(this).hasClass('choose_store')) { 
					 
						userPicker.setData([1,2.2,3,4,5]);
						userPicker.show(function(items) {
							console.log(8888,items)
							$('.choose_store a').html(items[0]);
						 
						});
					}
				 
				}, true);
			});
		});
	//选择器
	(function(mui) {
		//时间选择
		var btns = mui('.choose_time');
		btns.each(function(i, btn) {
			btn.addEventListener('tap', function() {
				input.blur();
				var _self = this;
				if (_self.picker) {
					_self.picker.show(function(rs) {
						$(_self).html(rs.text);
						if($(_self).hasClass('plan_timess')) {
							if ($(_self).hasClass('start_times')) {
								startTimes = rs.text;
							}
							if ($(_self).hasClass('end_times')) {
								endTimes = rs.text;
							}
						}
						_self.picker.dispose();
						_self.picker = null;
					});
				} else {
					var optionsJson = this.getAttribute('data-options') || '{}';
					var options = JSON.parse(optionsJson);
					var id = this.getAttribute('id');
					options.type = 'date';
					 
					if($(_self).hasClass('plan_timess')) {
						if ($(_self).hasClass('end_times') && startTimes) {
							options.beginDate = new Date(startTimes);
						}
						if ($(_self).hasClass('start_times') && endTimes) {
							options.endDate = new Date(endTimes);
						}
					}
						
					_self.picker = new mui.DtPicker(options);
	
					_self.picker.show(function(rs) {
						$(_self).html(rs.text);
						 
						if($(_self).hasClass('plan_timess')) {
							if ($(_self).hasClass('start_times')) {
								startTimes = rs.text;
							}
							if ($(_self).hasClass('end_times')) {
								endTimes = rs.text;
							}
						}
						
						_self.picker.dispose();
						_self.picker = null;
					});
				}
			}, false);
		});
	})(mui);
</script>
<script src="../../../js/delete.js" type="text/javascript" charset="utf-8"></script>
